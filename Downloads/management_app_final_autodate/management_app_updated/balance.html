<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh S√°ch T√™n - H·ªá Th·ªëng Qu·∫£n L√Ω</title>
    
    <!-- Preconnect to CDN -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/sheet.css" />
    
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="index.html">üè† Trang Ch·ªß</a>
        <a href="dashboard.html">üìä B·∫£ng Ch√≠nh</a>
        <a href="AE.html">üíº B·∫£ng AE</a>
        <a href="AE-QT.html">üåê B·∫£ng AE-QT</a>
        <a href="balance.html" class="active">üë• Danh S√°ch T√™n</a>
        <a href="usdt-purchase.html">üí∞ Nh·∫≠p USDT</a>
        <a href="rate.html">üí± T·ª∑ Gi√° USD</a>
        <a href="expense.html">üí∏ Thu Chi</a>
        <a href="settings.html">‚öôÔ∏è C√†i ƒê·∫∑t</a>
    </nav>

    <div class="container">
        <!-- Header -->
        <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h1 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 32px;">üë•</span>
                    Danh S√°ch T√™n
                </h1>
                <div style="display: flex; gap: 12px;">
                    <button id="manage-staff-btn" style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>üë§</span> Qu·∫£n L√Ω NV
                    </button>
                    <button id="refresh-btn" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>üîÑ</span> L√†m m·ªõi
                    </button>
                    <button id="export-balance-btn" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>üì•</span> Xu·∫•t Excel
                    </button>
                </div>
            </div>

            <!-- Th·ªëng k√™ t·ªïng quan -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px; border-radius: 10px; color: white;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">T·ªïng S·ªë Ng∆∞·ªùi</div>
                    <div id="stat-total-people" style="font-size: 24px; font-weight: 700;">0</div>
                </div>
                <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 16px; border-radius: 10px; color: white;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">S·ªë D∆∞∆°ng</div>
                    <div id="stat-positive" style="font-size: 24px; font-weight: 700;">0</div>
                </div>
                <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 16px; border-radius: 10px; color: white;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">S·ªë √Çm</div>
                    <div id="stat-negative" style="font-size: 24px; font-weight: 700;">0</div>
                </div>
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 16px; border-radius: 10px; color: white;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">C√¢n B·∫±ng (0)</div>
                    <div id="stat-zero" style="font-size: 24px; font-weight: 700;">0</div>
                </div>
            </div>
        </div>

        <!-- B·ªô l·ªçc v√† t√¨m ki·∫øm -->
        <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">üîç T√¨m ki·∫øm t√™n</label>
                    <input type="text" id="search-name" placeholder="Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm..." style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">üìä L·ªçc theo tr·∫°ng th√°i</label>
                    <select id="filter-status" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        <option value="all">T·∫•t c·∫£</option>
                        <option value="positive">S·ªë d∆∞∆°ng (N·ª£ cho)</option>
                        <option value="negative">S·ªë √¢m (N·ª£ ng∆∞·ªùi kh√°c)</option>
                        <option value="zero">C√¢n b·∫±ng (0)</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">üî¢ S·∫Øp x·∫øp</label>
                    <select id="sort-by" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        <option value="name-asc">T√™n (A-Z)</option>
                        <option value="name-desc">T√™n (Z-A)</option>
                        <option value="balance-desc">S·ªë d∆∞ (Cao ‚Üí Th·∫•p)</option>
                        <option value="balance-asc">S·ªë d∆∞ (Th·∫•p ‚Üí Cao)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Danh s√°ch ng∆∞·ªùi - Hai c·ªôt ri√™ng bi·ªát -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <!-- C·ªôt tr√°i: B·∫£ng AE -->
            <div>
                <h2 style="margin: 0 0 16px 0; color: #1e40af; display: flex; align-items: center; gap: 8px; padding: 12px; background: #dbeafe; border-radius: 8px; font-size: 18px;">
                    <span style="font-size: 24px;">üíº</span>
                    NV B·∫£ng AE
                </h2>
                <div id="people-list-ae" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                    <!-- Cards AE s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông - Hi·ªÉn th·ªã 4 th·∫ª m·ªói h√†ng, t·ª± ƒë·ªông xu·ªëng d√≤ng -->
                </div>
                <div id="empty-state-ae" style="display: none; text-align: center; padding: 40px 15px; background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 48px; margin-bottom: 12px;">üíº</div>
                    <h3 style="color: #6b7280; margin-bottom: 8px; font-size: 16px;">Ch∆∞a c√≥ d·ªØ li·ªáu NV AE</h3>
                    <p style="color: #9ca3af; font-size: 13px; margin: 0 0 16px 0; line-height: 1.6;">
                        Trang n√†y t·ª± ƒë·ªông hi·ªÉn th·ªã t√™n nh√¢n vi√™n t·ª´ <strong>B·∫£ng AE</strong>.<br>
                        Vui l√≤ng nh·∫≠p d·ªØ li·ªáu v√†o c·ªôt <strong>"T√™n NV"</strong> trong B·∫£ng AE ƒë·ªÉ b·∫Øt ƒë·∫ßu theo d√µi c√¥ng n·ª£.
                    </p>
                    <button onclick="window.location.href='AE.html'" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                        üìä M·ªü B·∫£ng AE
                    </button>
                </div>
            </div>

            <!-- C·ªôt ph·∫£i: B·∫£ng AE-QT -->
            <div>
                <h2 style="margin: 0 0 16px 0; color: #92400e; display: flex; align-items: center; gap: 8px; padding: 12px; background: #fef3c7; border-radius: 8px; font-size: 18px;">
                    <span style="font-size: 24px;">üåê</span>
                    NV B·∫£ng AE-QT
                </h2>
                <div id="people-list-aeqt" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                    <!-- Cards AE-QT s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông - Hi·ªÉn th·ªã 4 th·∫ª m·ªói h√†ng, t·ª± ƒë·ªông xu·ªëng d√≤ng -->
                </div>
                <div id="empty-state-aeqt" style="display: none; text-align: center; padding: 40px 15px; background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 48px; margin-bottom: 12px;">üåê</div>
                    <h3 style="color: #6b7280; margin-bottom: 8px; font-size: 16px;">Ch∆∞a c√≥ d·ªØ li·ªáu NV AE-QT</h3>
                    <p style="color: #9ca3af; font-size: 13px; margin: 0 0 16px 0; line-height: 1.6;">
                        Trang n√†y t·ª± ƒë·ªông hi·ªÉn th·ªã T√™n NV t·ª´ <strong>B·∫£ng AE-QT</strong>.<br>
                        Vui l√≤ng nh·∫≠p d·ªØ li·ªáu v√†o c·ªôt <strong>"T√™n NV"</strong> trong B·∫£ng AE-QT ƒë·ªÉ b·∫Øt ƒë·∫ßu theo d√µi c√¥ng n·ª£.
                    </p>
                    <button onclick="window.location.href='AE-QT.html'" style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s;" onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">
                        üìä M·ªü B·∫£ng AE-QT
                    </button>
                </div>
            </div>
        </div>

        <!-- Empty state -->
        <!-- Removed - now using separate empty states for AE and AE-QT -->

        <!-- Modal chi ti·∫øt -->
        <div id="detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
                <div style="padding: 24px; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <h2 id="modal-title" style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 28px;">üë§</span>
                        <span id="modal-name">T√™n ng∆∞·ªùi</span>
                    </h2>
                    <button onclick="closeDetailModal()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï ƒê√≥ng</button>
                </div>
                <div style="padding: 24px;">
                    <!-- T·ªïng quan -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;">
                        <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 11px; color: #1e40af; margin-bottom: 4px;">T·ªïng Ng√†y ƒê·ªïi</div>
                            <div id="modal-total-doi" style="font-size: 16px; font-weight: 700; color: #1e40af;">0‚Ç´</div>
                        </div>
                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 11px; color: #92400e; margin-bottom: 4px;">T·ªïng Ng√†y L·∫•y</div>
                            <div id="modal-total-lay" style="font-size: 16px; font-weight: 700; color: #92400e;">0‚Ç´</div>
                        </div>
                        <!-- Th·∫ª cho nh√¢n vi√™n AE -->
                        <div id="modal-card-ae" style="display: none; background: #dbeafe; padding: 12px; border-radius: 8px; border-left: 4px solid #2563eb;">
                            <div style="font-size: 11px; color: #1e40af; margin-bottom: 4px;">üíº Nh·∫≠n AE (√ó0.5)</div>
                            <div id="modal-total-tt-ae" style="font-size: 16px; font-weight: 700; color: #1e40af;">0‚Ç´</div>
                        </div>
                        <!-- Th·∫ª cho nh√¢n vi√™n AE-QT -->
                        <div id="modal-card-aeqt" style="display: none; background: #fce7f3; padding: 12px; border-radius: 8px; border-left: 4px solid #ec4899;">
                            <div style="font-size: 11px; color: #9f1239; margin-bottom: 4px;">üåê Nh·∫≠n AE-QT (√ó0.8)</div>
                            <div id="modal-total-tt-aeqt" style="font-size: 16px; font-weight: 700; color: #9f1239;">0‚Ç´</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid #e5e7eb; overflow-x: auto;">
                        <button class="modal-tab active" data-tab="doi" onclick="switchModalTab('doi')" style="padding: 10px 16px; background: none; border: none; border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 13px;">
                            üìÖ Ng√†y ƒê·ªïi (<span id="count-doi">0</span>)
                        </button>
                        <button class="modal-tab" data-tab="lay" onclick="switchModalTab('lay')" style="padding: 10px 16px; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 13px;">
                            üí∞ Ng√†y L·∫•y (<span id="count-lay">0</span>)
                        </button>
                        <button class="modal-tab" data-tab="ae" onclick="switchModalTab('ae')" style="padding: 10px 16px; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 13px;">
                            üíº B·∫£ng AE (<span id="count-ae">0</span>)
                        </button>
                        <button class="modal-tab" data-tab="aeqt" onclick="switchModalTab('aeqt')" style="padding: 10px 16px; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 13px;">
                            üåê B·∫£ng AE-QT (<span id="count-aeqt">0</span>)
                        </button>
                    </div>

                    <!-- N·ªôi dung tabs -->
                    <div id="modal-tab-doi" class="modal-tab-content">
                        <div id="modal-list-doi" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Danh s√°ch Ng√†y ƒê·ªïi -->
                        </div>
                    </div>
                    <div id="modal-tab-lay" class="modal-tab-content" style="display: none;">
                        <div id="modal-list-lay" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Danh s√°ch Ng√†y L·∫•y -->
                        </div>
                    </div>
                    <div id="modal-tab-ae" class="modal-tab-content" style="display: none;">
                        <div id="modal-list-ae" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Danh s√°ch B·∫£ng AE -->
                        </div>
                    </div>
                    <div id="modal-tab-aeqt" class="modal-tab-content" style="display: none;">
                        <div id="modal-list-aeqt" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Danh s√°ch B·∫£ng AE-QT -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Qu·∫£n L√Ω NV -->
        <div id="staff-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
                <div style="padding: 24px; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 28px;">üë§</span>
                        Qu·∫£n L√Ω NV
                    </h2>
                    <button onclick="closeStaffModal()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï ƒê√≥ng</button>
                </div>
                <div style="padding: 24px;">
                    <!-- Two columns layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        
                        <!-- Column 1: B·∫£ng AE -->
                        <div style="border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; background: #f0f9ff;">
                            <h3 style="margin: 0 0 16px 0; color: #1e40af; display: flex; align-items: center; gap: 8px; font-size: 18px;">
                                <span style="font-size: 24px;">üíº</span>
                                Nh√¢n Vi√™n B·∫£ng AE
                            </h3>
                            
                            <!-- Form th√™m AE -->
                            <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #bfdbfe;">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1e40af; font-size: 13px;">‚ûï Th√™m NV M·ªõi</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" id="new-staff-ae" placeholder="Nh·∫≠p t√™n (c√≥ th·ªÉ nhi·ªÅu t√™n, c√°ch nhau b·∫±ng d·∫•u ph·∫©y)" style="flex: 1; padding: 8px 10px; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 13px;">
                                    <button onclick="addStaffFromModal('ae')" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; white-space: nowrap;">Th√™m</button>
                                </div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 6px;">üí° V√≠ d·ª•: An, B√¨nh, Ch√¢u</div>
                            </div>

                            <!-- T√¨m ki·∫øm AE -->
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <input type="text" id="staff-search-ae" placeholder="üîç T√¨m ki·∫øm..." style="flex: 1; padding: 8px; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 13px; background: white;">
                                <button onclick="sortStaffListInModal('ae')" style="padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 12px;">A-Z</button>
                                <button onclick="exportStaffListFromModal('ae')" style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 12px;">üì•</button>
                            </div>

                            <!-- Danh s√°ch AE -->
                            <div id="staff-list-ae" style="display: flex; flex-direction: column; gap: 6px; max-height: 450px; overflow-y: auto; padding: 4px;">
                                <!-- AE staff items -->
                            </div>

                            <!-- Empty state AE -->
                            <div id="staff-empty-ae" style="display: none; text-align: center; padding: 30px 15px; background: white; border-radius: 8px; border: 1px dashed #bfdbfe;">
                                <div style="font-size: 40px; margin-bottom: 8px;">üíº</div>
                                <p style="color: #6b7280; margin: 0; font-size: 13px;">Ch∆∞a c√≥ NV AE</p>
                            </div>
                        </div>

                        <!-- Column 2: B·∫£ng AE-QT -->
                        <div style="border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; background: #fffbeb;">
                            <h3 style="margin: 0 0 16px 0; color: #92400e; display: flex; align-items: center; gap: 8px; font-size: 18px;">
                                <span style="font-size: 24px;">üåê</span>
                                NV B·∫£ng AE-QT
                            </h3>
                            
                            <!-- Form th√™m AE-QT -->
                            <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #fde68a;">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #92400e; font-size: 13px;">‚ûï Th√™m NV M·ªõi</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" id="new-staff-aeqt" placeholder="Nh·∫≠p t√™n (c√≥ th·ªÉ nhi·ªÅu t√™n, c√°ch nhau b·∫±ng d·∫•u ph·∫©y)" style="flex: 1; padding: 8px 10px; border: 1px solid #fde68a; border-radius: 6px; font-size: 13px;">
                                    <button onclick="addStaffFromModal('aeqt')" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; white-space: nowrap;">Th√™m</button>
                                </div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 6px;">üí° V√≠ d·ª•: An, B√¨nh, Ch√¢u</div>
                            </div>

                            <!-- T√¨m ki·∫øm AE-QT -->
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <input type="text" id="staff-search-aeqt" placeholder="üîç T√¨m ki·∫øm..." style="flex: 1; padding: 8px; border: 1px solid #fde68a; border-radius: 6px; font-size: 13px; background: white;">
                                <button onclick="sortStaffListInModal('aeqt')" style="padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 12px;">A-Z</button>
                                <button onclick="exportStaffListFromModal('aeqt')" style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 12px;">üì•</button>
                            </div>

                            <!-- Danh s√°ch AE-QT -->
                            <div id="staff-list-aeqt" style="display: flex; flex-direction: column; gap: 6px; max-height: 450px; overflow-y: auto; padding: 4px;">
                                <!-- AE-QT staff items -->
                            </div>

                            <!-- Empty state AE-QT -->
                            <div id="staff-empty-aeqt" style="display: none; text-align: center; padding: 30px 15px; background: white; border-radius: 8px; border: 1px dashed #fde68a;">
                                <div style="font-size: 40px; margin-bottom: 8px;">üåê</div>
                                <p style="color: #6b7280; margin: 0; font-size: 13px;">Ch∆∞a c√≥ NV AE-QT</p>
                            </div>
                        </div>

                    </div>

                    <!-- Info box -->
                    <div style="margin-top: 20px; padding: 12px 16px; background: #e0f2fe; border-left: 4px solid #0284c7; border-radius: 6px;">
                        <p style="margin: 0; color: #0c4a6e; font-size: 13px; line-height: 1.6;">
                            <strong>üí° L∆∞u √Ω:</strong> Hai danh s√°ch ri√™ng bi·ªát gi√∫p tr√°nh nh·∫ßm l·∫´n khi ch·ªçn nh√¢n vi√™n. Danh s√°ch b√™n tr√°i cho B·∫£ng AE, b√™n ph·∫£i cho B·∫£ng AE-QT.
                        </p>
                    </div>
                </div>
            </div>
        </div>

    <!-- Scripts -->
    <script src="assets/js/notification.js"></script>
    <script src="assets/js/formulas.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/button-effects.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-sync.js"></script>
    <script src="assets/js/balance.js"></script>
    <script src="assets/js/balance-split.js"></script>
    <script src="assets/js/note-manager.js"></script>
    <script src="assets/js/export.js"></script>
    
    <script>
        // ====================================
        // Staff Manager - Two Separate Lists
        // ====================================
        const STAFF_AE_KEY = 'staff_list_ae';
        const STAFF_AEQT_KEY = 'staff_list_aeqt';
        let staffListAE = [];
        let staffListAEQT = [];
        let staffSortAscendingAE = true;
        let staffSortAscendingAEQT = true;

        // Load staff lists from localStorage
        function loadStaffListData() {
            try {
                const storedAE = localStorage.getItem(STAFF_AE_KEY);
                const storedAEQT = localStorage.getItem(STAFF_AEQT_KEY);
                staffListAE = storedAE ? JSON.parse(storedAE) : [];
                staffListAEQT = storedAEQT ? JSON.parse(storedAEQT) : [];
                console.log('üìã Staff AE loaded:', staffListAE.length);
                console.log('üìã Staff AE-QT loaded:', staffListAEQT.length);
            } catch (e) {
                console.error('Error loading staff lists:', e);
                staffListAE = [];
                staffListAEQT = [];
            }
        }

        // Save staff list to localStorage
        function saveStaffListData(type) {
            try {
                const key = type === 'ae' ? STAFF_AE_KEY : STAFF_AEQT_KEY;
                const list = type === 'ae' ? staffListAE : staffListAEQT;
                
                localStorage.setItem(key, JSON.stringify(list));
                console.log(`‚úÖ Staff ${type.toUpperCase()} saved:`, list.length, 'items');
                
                // Auto-sync to Supabase if available
                if (window.SupabaseSync && typeof window.SupabaseSync.push === 'function') {
                    window.SupabaseSync.push(key).catch(err => {
                        console.log('‚è≠Ô∏è Supabase sync skipped:', err.message);
                    });
                }
            } catch (e) {
                console.error('Error saving staff list:', e);
                alert('L·ªói khi l∆∞u danh s√°ch!');
            }
        }

        // HTML escape to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Validate staff name
        function validateStaffName(name) {
            if (!name || name.trim() === '') {
                return { valid: false, message: 'T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!' };
            }
            const trimmed = name.trim();
            if (trimmed.length < 2) {
                return { valid: false, message: 'T√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±!' };
            }
            if (trimmed.length > 50) {
                return { valid: false, message: 'T√™n kh√¥ng ƒë∆∞·ª£c qu√° 50 k√Ω t·ª±!' };
            }
            // Allow Vietnamese characters, spaces, and basic punctuation
            const validPattern = /^[a-zA-Z√Ä-·ªπ\s\-'.]+$/;
            if (!validPattern.test(trimmed)) {
                return { valid: false, message: 'T√™n ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i, kho·∫£ng tr·∫Øng v√† d·∫•u g·∫°ch ngang!' };
            }
            return { valid: true, name: trimmed };
        }
        
        // Get staff list (public API for autocomplete)
        window.getStaffList = function(type) {
            loadStaffListData();
            if (type === 'ae') {
                return [...staffListAE];
            } else if (type === 'aeqt') {
                return [...staffListAEQT];
            } else {
                // For backward compatibility, return combined list
                return [...staffListAE, ...staffListAEQT];
            }
        }

        // Add staff (silent mode for batch operations)
        window.addStaff = function(name, type, silent = false) {
            loadStaffListData();
            
            // Validate name
            const validation = validateStaffName(name);
            if (!validation.valid) {
                if (!silent) alert(validation.message);
                return false;
            }
            
            const trimmedName = validation.name;
            const list = type === 'ae' ? staffListAE : staffListAEQT;
            
            // Check duplicate (case-insensitive)
            if (list.some(s => s.toLowerCase() === trimmedName.toLowerCase())) {
                if (!silent) alert('Nh√¢n vi√™n "' + trimmedName + '" ƒë√£ t·ªìn t·∫°i!');
                return false;
            }

            if (type === 'ae') {
                staffListAE.push(trimmedName);
            } else {
                staffListAEQT.push(trimmedName);
            }
            
            saveStaffListData(type);
            if (!silent) {
                const typeLabel = type === 'ae' ? 'AE' : 'AE-QT';
                showStaffNotification('‚úÖ ƒê√£ th√™m: ' + trimmedName + ' (' + typeLabel + ')');
            }
            return true;
        }

        // Edit staff
        window.editStaff = function(oldName, newName, type) {
            loadStaffListData();
            
            // Validate new name
            const validation = validateStaffName(newName);
            if (!validation.valid) {
                alert(validation.message);
                return false;
            }
            
            const trimmedNewName = validation.name;
            
            // No change
            if (trimmedNewName === oldName) {
                return false;
            }
            
            const list = type === 'ae' ? staffListAE : staffListAEQT;
            
            // Check if new name already exists (excluding current)
            if (list.some(s => s !== oldName && s.toLowerCase() === trimmedNewName.toLowerCase())) {
                alert('T√™n "' + trimmedNewName + '" ƒë√£ t·ªìn t·∫°i!');
                return false;
            }

            const index = list.indexOf(oldName);
            if (index > -1) {
                if (type === 'ae') {
                    staffListAE[index] = trimmedNewName;
                } else {
                    staffListAEQT[index] = trimmedNewName;
                }
                saveStaffListData(type);
                showStaffNotification('‚úèÔ∏è ƒê√£ c·∫≠p nh·∫≠t: ' + oldName + ' ‚Üí ' + trimmedNewName);
                return true;
            }
            return false;
        }

        // Delete staff
        window.deleteStaff = function(name, type) {
            loadStaffListData();
            
            const list = type === 'ae' ? staffListAE : staffListAEQT;
            const index = list.indexOf(name);
            
            if (index > -1) {
                if (type === 'ae') {
                    staffListAE.splice(index, 1);
                } else {
                    staffListAEQT.splice(index, 1);
                }
                saveStaffListData(type);
                showStaffNotification('üóëÔ∏è ƒê√£ x√≥a: ' + name);
                return true;
            }
            return false;
        }

        // Sort staff list
        window.sortStaffList = function(type) {
            loadStaffListData();
            
            if (type === 'ae') {
                staffListAE.sort((a, b) => {
                    return staffSortAscendingAE 
                        ? a.localeCompare(b, 'vi') 
                        : b.localeCompare(a, 'vi');
                });
                staffSortAscendingAE = !staffSortAscendingAE;
                saveStaffListData('ae');
            } else {
                staffListAEQT.sort((a, b) => {
                    return staffSortAscendingAEQT 
                        ? a.localeCompare(b, 'vi') 
                        : b.localeCompare(a, 'vi');
                });
                staffSortAscendingAEQT = !staffSortAscendingAEQT;
                saveStaffListData('aeqt');
            }
        }

        // Export staff list
        window.exportStaffList = function(type) {
            loadStaffListData();
            
            const list = type === 'ae' ? staffListAE : staffListAEQT;
            const label = type === 'ae' ? 'AE' : 'AE-QT';
            
            if (list.length === 0) {
                alert('Danh s√°ch tr·ªëng!');
                return;
            }

            const csvContent = '\uFEFF' + 'STT,T√™n Nh√¢n Vi√™n ' + label + '\n' + 
                list.map((name, i) => `${i + 1},"${name}"`).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'Staff_' + label + '_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStaffNotification('üì• ƒê√£ xu·∫•t file CSV - ' + label);
        }

        // Show notification
        function showStaffNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // ====================================
        // Modal Management
        // ====================================
        
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Balance page loaded');
            
            // Load staff data on init
            loadStaffListData();
            
            // Open staff management modal
            const manageStaffBtn = document.getElementById('manage-staff-btn');
            
            if (manageStaffBtn) {
                manageStaffBtn.addEventListener('click', function() {
                    console.log('üëÜ Button clicked!');
                    const modal = document.getElementById('staff-modal');
                    
                    if (modal) {
                        modal.style.display = 'flex';
                        console.log('‚úÖ Modal display set to flex');
                        renderStaffListInModal('ae');
                        renderStaffListInModal('aeqt');
                    }
                });
            }
            
            // Enter key support for new staff inputs
            document.getElementById('new-staff-ae')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addStaffFromModal('ae');
            });
            
            document.getElementById('new-staff-aeqt')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addStaffFromModal('aeqt');
            });

            // Search staff
            document.getElementById('staff-search-ae')?.addEventListener('input', function() {
                renderStaffListInModal('ae');
            });
            
            document.getElementById('staff-search-aeqt')?.addEventListener('input', function() {
                renderStaffListInModal('aeqt');
            });
            
            // Close modal on outside click
            const staffModal = document.getElementById('staff-modal');
            if (staffModal) {
                staffModal.addEventListener('click', function(e) {
                    if (e.target.id === 'staff-modal') {
                        closeStaffModal();
                    }
                });
            }
        });

        // Close staff modal
        window.closeStaffModal = function() {
            const modal = document.getElementById('staff-modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚úÖ Modal closed');
            }
        }

        // Add staff from modal
        window.addStaffFromModal = function(type) {
            const inputId = type === 'ae' ? 'new-staff-ae' : 'new-staff-aeqt';
            const input = document.getElementById(inputId);
            if (!input) return;
            
            const inputValue = input.value.trim();
            if (!inputValue) {
                alert('Vui l√≤ng nh·∫≠p t√™n nh√¢n vi√™n!');
                return;
            }
            
            // Split by comma and process each name
            const names = inputValue.split(',').map(name => name.trim()).filter(name => name.length > 0);
            
            if (names.length === 0) {
                alert('Vui l√≤ng nh·∫≠p t√™n h·ª£p l·ªá!');
                return;
            }
            
            let addedCount = 0;
            let duplicateCount = 0;
            const addedNames = [];
            
            names.forEach(name => {
                if (addStaff(name, type)) {
                    addedCount++;
                    addedNames.push(name);
                } else {
                    duplicateCount++;
                }
            });
            
            // Clear input and refresh list
            input.value = '';
            renderStaffListInModal(type);
            
            // Show summary notification
            if (addedCount > 0) {
                const typeLabel = type === 'ae' ? 'AE' : 'AE-QT';
                if (addedCount === 1) {
                    showStaffNotification(`‚úÖ ƒê√£ th√™m: ${addedNames[0]} (${typeLabel})`);
                } else {
                    showStaffNotification(`‚úÖ ƒê√£ th√™m ${addedCount} NV v√†o ${typeLabel}${duplicateCount > 0 ? ` (${duplicateCount} tr√πng)` : ''}`);
                }
            } else if (duplicateCount > 0) {
                alert('T·∫•t c·∫£ t√™n ƒë√£ t·ªìn t·∫°i trong danh s√°ch!');
            }
        }

        // Render staff list in modal
        window.renderStaffListInModal = function(type) {
            console.log('üé® Rendering staff list for:', type);
            loadStaffListData();
            
            const searchId = type === 'ae' ? 'staff-search-ae' : 'staff-search-aeqt';
            const containerId = type === 'ae' ? 'staff-list-ae' : 'staff-list-aeqt';
            const emptyStateId = type === 'ae' ? 'staff-empty-ae' : 'staff-empty-aeqt';
            const buttonColor = type === 'ae' ? '#3b82f6' : '#f59e0b';
            
            const searchInput = document.getElementById(searchId);
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            const list = type === 'ae' ? staffListAE : staffListAEQT;
            const filteredList = list.filter(name => 
                name.toLowerCase().includes(searchTerm)
            );

            const container = document.getElementById(containerId);
            const emptyState = document.getElementById(emptyStateId);

            if (!container || !emptyState) {
                console.error('‚ùå Container or empty state not found for', type);
                return;
            }

            if (filteredList.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                console.log('üì≠ No staff to display for', type);
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = filteredList.map((name, idx) => {
                const escapedName = escapeHtml(name);
                const escapedForJs = name.replace(/'/g, "\\'")
                    .replace(/"/g, '\\"')
                    .replace(/\\/g, '\\\\');
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s; animation: slideIn 0.2s ease ${idx * 0.03}s both;">
                        <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                            <span style="font-size: 16px;">${type === 'ae' ? 'üíº' : 'üåê'}</span>
                            <span style="font-weight: 600; color: #1f2937; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapedName}">${escapedName}</span>
                        </div>
                        <div style="display: flex; gap: 6px; flex-shrink: 0;">
                            <button onclick="editStaffFromModal('${escapedForJs}', '${type}')" style="padding: 5px 10px; background: ${buttonColor}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s;" onmouseenter="this.style.opacity='0.8'" onmouseleave="this.style.opacity='1'">‚úèÔ∏è S·ª≠a</button>
                            <button onclick="deleteStaffFromModal('${escapedForJs}', '${type}')" style="padding: 5px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s;" onmouseenter="this.style.opacity='0.8'" onmouseleave="this.style.opacity='1'">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('‚úÖ Rendered', filteredList.length, type, 'staff members');
        }

        // Edit staff from modal
        window.editStaffFromModal = function(oldName, type) {
            const newName = prompt('S·ª≠a t√™n nh√¢n vi√™n:', oldName);
            if (newName && newName.trim() && newName.trim() !== oldName) {
                if (editStaff(oldName, newName.trim(), type)) {
                    renderStaffListInModal(type);
                }
            }
        }

        // Delete staff from modal
        window.deleteStaffFromModal = function(name, type) {
            if (confirm(`X√°c nh·∫≠n x√≥a nh√¢n vi√™n "${name}"?`)) {
                if (deleteStaff(name, type)) {
                    renderStaffListInModal(type);
                }
            }
        }

        // Sort staff list
        window.sortStaffListInModal = function(type) {
            sortStaffList(type);
            renderStaffListInModal(type);
        }

        // Export staff list
        window.exportStaffListFromModal = function(type) {
            exportStaffList(type);
        }

        // Close modal on ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeStaffModal();
            }
        });

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
