<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ª∑ Gi√° USD</title>
    
    <!-- Preconnect to CDN -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
    <nav class="navbar">
        <a href="index.html">üè† Trang Ch·ªß</a>
        <a href="dashboard.html">üìä B·∫£ng Ch√≠nh</a>
        <a href="AE.html">üíº B·∫£ng AE</a>
        <a href="AE-QT.html">üåê B·∫£ng AE-QT</a>
        <a href="balance.html">üë• Danh S√°ch T√™n</a>
        <a href="usdt-purchase.html">üí∞ Nh·∫≠p USDT</a>
        <a href="rate.html" class="active">üí± T·ª∑ Gi√° USD</a>
        <a href="expense.html">üí∏ Thu Chi</a>
        <a href="settings.html">‚öôÔ∏è C√†i ƒê·∫∑t</a>
    </nav>

    <style>
        .rate-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .rate-header h2 {
            margin: 0 0 16px 0;
            font-size: 28px;
            font-weight: 700;
        }
        .rate-info-card {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .rate-info-card .label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .rate-info-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        .status-badge[data-status="loading"] {
            background: #fef3c7;
            color: #92400e;
        }
        .status-badge[data-status="success"] {
            background: #d1fae5;
            color: #065f46;
        }
        .status-badge[data-status="warning"] {
            background: #fed7aa;
            color: #9a3412;
        }
        .status-badge[data-status="error"] {
            background: #fee2e2;
            color: #991b1b;
        }
        .status-badge[data-status="loading"]::before {
            content: "‚è≥";
        }
        .status-badge[data-status="success"]::before {
            content: "‚úÖ";
        }
        .status-badge[data-status="warning"]::before {
            content: "‚ö†Ô∏è";
        }
        .status-badge[data-status="error"]::before {
            content: "‚ùå";
        }
    </style>

    <div class="container">
        <div class="rate-header">
            <h2>üí± T·ª∑ Gi√° USD/VND</h2>
            <div class="rate-info-card">
                <div>
                    <div class="label">Gi√° P2P Binance (1 USDT = VND)</div>
                    <div class="value" id="rate-current-price">ƒêang t·∫£i‚Ä¶</div>
                </div>
                <div style="text-align: right;">
                    <span id="rate-fetch-status" class="status-badge" data-status="loading">ƒêang t·∫£i t·ª∑ gi√°‚Ä¶</span>
                </div>
            </div>
        </div>
        <form id="rate-form">
            <div class="form-grid">
                <label class="hidden-row">
                    Gi√° b√°n (‚Ç´/USDT)
                    <input type="number" id="rate-sell-price" step="0.01" min="0" placeholder="VND" />
                </label>
                <label>
                    Gi√° mua (‚Ç´/USDT)
                    <input type="number" id="rate-buy-price" step="0.01" min="0" placeholder="VND" />
                </label>
                <label class="hidden-row">
                    Lo·∫°i giao d·ªãch
                    <select id="rate-type">
                        <option value="sell">B√°n USDT</option>
                        <option value="buy" selected>Mua USDT</option>
                    </select>
                </label>
                <label>
                    S·ªë l∆∞·ª£ng (USDT)
                    <input type="number" id="rate-amount" step="0.01" min="0" placeholder="0.00 USDT" />
                </label>
                <div class="form-actions">
                    <button type="submit" class="btn" id="rate-convert-btn">Chuy·ªÉn ƒë·ªïi</button>
                </div>
            </div>
        </form>
        <h3>K·∫øt qu·∫£ (VND): <span id="rate-result">0¬†‚Ç´</span></h3>
        <h3>L·ªãch S·ª≠ chuy·ªÉn ƒë·ªïi</h3>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
                <p style="margin: 0 0 4px 0; color: #1f2937; font-weight: 600; font-size: 15px;">
                    T·∫•t c·∫£ giao d·ªãch (<span id="rate-history-count">0</span>)
                </p>
                <p style="margin: 0; color: #6b7280; font-size: 13px;">
                    T·ªïng gi√° tr·ªã: <span id="rate-history-total" style="font-weight: 600; color: #10b981;">0‚Ç´</span>
                </p>
            </div>
            <div style="display: flex; gap: 8px;">
                <select id="rate-history-filter" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; cursor: pointer;">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="buy">Ch·ªâ Mua</option>
                    <option value="sell">Ch·ªâ B√°n</option>
                </select>
                <select id="rate-history-sort" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; cursor: pointer;">
                    <option value="newest">M·ªõi nh·∫•t</option>
                    <option value="oldest">C≈© nh·∫•t</option>
                    <option value="highest">Gi√° cao nh·∫•t</option>
                    <option value="lowest">Gi√° th·∫•p nh·∫•t</option>
                </select>
            </div>
        </div>
        <div class="table-responsive">
            <table id="rate-history-table">
                <thead>
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>Lo·∫°i</th>
                        <th>S·ªë l∆∞·ª£ng (USDT)</th>
                        <th>Gi√° (‚Ç´/USDT)</th>
                        <th>Th√†nh ti·ªÅn (‚Ç´)</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button id="clear-rate-history" class="btn btn-danger btn-spacing">X√≥a l·ªãch s·ª≠</button>
        <div id="rate-export-container"></div>

        <section id="system-embed-root" data-page="rate" class="system-embed-section"></section>
    </div>

    <script src="config.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/button-effects.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="assets/js/export.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-sync.js"></script>
    <script>
    (function() {
        // References to form fields
        const sellPriceInput = document.getElementById('rate-sell-price');
        const buyPriceInput  = document.getElementById('rate-buy-price');
        const typeSelect    = document.getElementById('rate-type');
        const amountInput   = document.getElementById('rate-amount');
        const resultEl      = document.getElementById('rate-result');
        const form          = document.getElementById('rate-form');
        const tbody         = document.querySelector('#rate-history-table tbody');
        const clearBtn      = document.getElementById('clear-rate-history');
        const currentPriceEl= document.getElementById('rate-current-price');
        const statusEl      = document.getElementById('rate-fetch-status');
        const historyKey    = 'rate-history';
        const settingsKey   = 'rate-settings';
        let crossRate       = 0; // fallback rate from API
        let currentFilter   = 'all';
        let currentSort     = 'newest';

        // Use global formatVND from app.js

        function updateFetchStatus(message, level = 'info') {
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.setAttribute('data-status', level);
        }

        async function fetchRates() {
            try {
                updateFetchStatus('ƒêang l·∫•y t·ª∑ gi√° t·ª´ Binance P2P‚Ä¶', 'loading');
                
                // Try Netlify Function first (bypasses CORS)
                const origin = window.location.origin;
                const endpoints = [
                    `${origin}/.netlify/functions/p2p-rate`,
                    'http://localhost:3000/api/p2p-rate',
                    'http://localhost:3001/api/p2p-rate'
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        console.log('üîÑ Trying:', endpoint);
                        const response = await fetch(endpoint, { 
                            method: 'GET',
                            cache: 'no-store' 
                        });
                        
                        if (!response.ok) {
                            console.warn(`‚ö†Ô∏è ${endpoint} returned ${response.status}`);
                            continue;
                        }
                        
                        const payload = await response.json();
                        console.log('üìä Response:', payload);
                        
                        const sell = parseFloat(payload.sellPrice) || 0;
                        const buy = parseFloat(payload.buyPrice) || 0;
                        
                        crossRate = buy || sell;
                        
                        if (crossRate > 0) {
                            currentPriceEl.textContent = formatVND(crossRate);
                            prefillPrices();
                            
                            // Save to localStorage
                            const settings = {
                                sellPrice: sell,
                                buyPrice: buy,
                                source: payload.source || 'api',
                                updatedAt: new Date().toISOString()
                            };
                            localStorage.setItem(settingsKey, JSON.stringify(settings));
                            
                            updateFetchStatus('‚úÖ ƒê√£ l·∫•y t·ª∑ gi√° P2P m·ªõi nh·∫•t t·ª´ Binance', 'success');
                            console.log('‚úÖ Rate fetched:', crossRate, 'VND');
                            return;
                        }
                    } catch (err) {
                        console.warn(`‚ùå Failed ${endpoint}:`, err.message);
                    }
                }
                
                throw new Error('All endpoints failed');
            } catch (err) {
                console.error('Failed to fetch P2P rate:', err);
                updateFetchStatus('Kh√¥ng l·∫•y ƒë∆∞·ª£c t·ª∑ gi√° P2P, ƒëang d√πng ngu·ªìn d·ª± ph√≤ng.', 'warning');
                await fetchFallbackRates();
            }
        }

        async function fetchFallbackRates() {
            try {
                updateFetchStatus('ƒêang th·ª≠ ngu·ªìn d·ª± ph√≤ng‚Ä¶', 'warning');
                
                // Try ExchangeRate API
                const fxRes = await fetch('https://open.er-api.com/v6/latest/USD');
                const fxData = await fxRes.json();
                const usdToVnd = fxData && fxData.rates && fxData.rates.VND ? fxData.rates.VND : 0;
                
                if (usdToVnd > 0) {
                    crossRate = usdToVnd;
                    currentPriceEl.textContent = formatVND(crossRate);
                    prefillPrices();
                    updateFetchStatus('ƒê√£ l·∫•y t·ª∑ gi√° t·ª´ ngu·ªìn d·ª± ph√≤ng (ExchangeRate API)', 'success');
                    console.log('‚úÖ Fallback rate fetched:', crossRate, 'VND');
                    return;
                }
                
                throw new Error('Fallback rate invalid');
            } catch (err) {
                console.error('Fallback rate fetch failed:', err);
                
                // Try to load from localStorage as last resort
                const settings = loadData(settingsKey);
                if (settings && settings.buyPrice > 0) {
                    crossRate = settings.buyPrice;
                    currentPriceEl.textContent = formatVND(crossRate) + ' (t·ª´ b·ªô nh·ªõ)';
                    prefillPrices();
                    updateFetchStatus('ƒêang d√πng t·ª∑ gi√° ƒë√£ l∆∞u (offline)', 'warning');
                } else {
                    currentPriceEl.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu';
                    updateFetchStatus('Kh√¥ng l·∫•y ƒë∆∞·ª£c t·ª∑ gi√°. Vui l√≤ng nh·∫≠p th·ªß c√¥ng.', 'error');
                }
            }
        }

        /** Prefill price inputs from settings or cross rate */
        function prefillPrices() {
            const settings = loadData(settingsKey);
            let sell = null;
            let buy  = null;
            if (settings && typeof settings === 'object' && !Array.isArray(settings)) {
                sell = parseFloat(settings.sellPrice);
                buy  = parseFloat(settings.buyPrice);
            }
            // Use stored settings if available, otherwise use crossRate
            // Only prefill if input is currently empty to avoid overriding user edits
            if (!sellPriceInput.value) {
                if (sell && sell > 0) {
                    sellPriceInput.value = sell.toFixed(2);
                } else if (crossRate > 0) {
                    sellPriceInput.value = crossRate.toFixed(2);
                }
            }
            if (!buyPriceInput.value) {
                if (buy && buy > 0) {
                    buyPriceInput.value = buy.toFixed(2);
                } else if (crossRate > 0) {
                    buyPriceInput.value = crossRate.toFixed(2);
                }
            }
            updateResult();

            if (crossRate <= 0 && !sell && !buy) {
                updateFetchStatus('Kh√¥ng c√≥ t·ª∑ gi√° tham kh·∫£o, h√£y nh·∫≠p gi√° b√°n/mua th·ªß c√¥ng.', 'warning');
            }
        }

        /** Render history rows with filter and sort */
        function renderHistory() {
            let conversions = loadData(historyKey);
            
            // Apply filter
            if (currentFilter !== 'all') {
                conversions = conversions.filter(item => item.type === currentFilter);
            }
            
            // Apply sort
            conversions.sort((a, b) => {
                switch(currentSort) {
                    case 'newest':
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    case 'oldest':
                        return new Date(a.timestamp) - new Date(b.timestamp);
                    case 'highest':
                        return b.vnd - a.vnd;
                    case 'lowest':
                        return a.vnd - b.vnd;
                    default:
                        return 0;
                }
            });
            
            // Update count and total
            const totalVnd = conversions.reduce((sum, item) => sum + (item.vnd || 0), 0);
            document.getElementById('rate-history-count').textContent = conversions.length;
            document.getElementById('rate-history-total').textContent = formatVND(totalVnd);
            
            tbody.innerHTML = '';
            conversions.forEach((item, index) => {
                const tr = document.createElement('tr');
                // Format type (sell/buy) to Vietnamese label
                const typeLabel = item.type === 'buy' ? 'Mua' : 'B√°n';
                const typeBadgeColor = item.type === 'buy' ? '#10b981' : '#f59e0b';
                const cells = [
                    // Format timestamp using Hanoi time zone (UTC+7) for consistency
                    (function() {
                        try {
                            return new Date(item.timestamp).toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
                        } catch (e) {
                            return new Date(item.timestamp).toLocaleString('vi-VN');
                        }
                    })(),
                    typeLabel,
                    item.amount,
                    formatVND(item.price),
                    formatVND(item.vnd)
                ];
                cells.forEach((text, i) => {
                    const td = document.createElement('td');
                    // Add badge style for type column
                    if (i === 1) {
                        td.innerHTML = `<span style="display: inline-block; padding: 4px 10px; background: ${typeBadgeColor}; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">${text}</span>`;
                    } else {
                        td.textContent = text;
                    }
                    tr.appendChild(td);
                });
                // Delete button - need to find original index
                const originalIndex = loadData(historyKey).findIndex(original => 
                    original.timestamp === item.timestamp && 
                    original.vnd === item.vnd
                );
                const actionTd = document.createElement('td');
                const delBtn = document.createElement('button');
                delBtn.textContent = 'X√≥a';
                delBtn.className = 'btn btn-danger';
                delBtn.addEventListener('click', () => deleteConversion(originalIndex));
                actionTd.appendChild(delBtn);
                tr.appendChild(actionTd);
                tbody.appendChild(tr);
            });
        }

        /** Delete a conversion from history */
        function deleteConversion(index) {
            const conversions = loadData(historyKey);
            conversions.splice(index, 1);
            saveData(historyKey, conversions);
            renderHistory();
        }

        /** Compute and update result based on current inputs */
        function updateResult() {
            const sellPrice = parseFloat(sellPriceInput.value) || 0;
            const buyPrice  = parseFloat(buyPriceInput.value) || 0;
            const amount    = parseFloat(amountInput.value) || 0;
            const type      = typeSelect.value;
            let priceUsed   = 0;
            if (type === 'sell') {
                priceUsed = sellPrice;
            } else {
                priceUsed = buyPrice;
            }
            const vnd = priceUsed * amount;
            resultEl.textContent = formatVND(vnd);
        }

        // Listen for input changes to update result dynamically
        sellPriceInput.addEventListener('input', updateResult);
        buyPriceInput.addEventListener('input', updateResult);
        amountInput.addEventListener('input', updateResult);
        typeSelect.addEventListener('change', updateResult);

        // Form submit event
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const sellPrice = parseFloat(sellPriceInput.value) || 0;
            const buyPrice  = parseFloat(buyPriceInput.value) || 0;
            const amount    = parseFloat(amountInput.value) || 0;
            const type      = typeSelect.value;
            let price = 0;
            if (type === 'sell') {
                price = sellPrice;
            } else {
                price = buyPrice;
            }
            if (price <= 0 || amount <= 0) {
                alert('Vui l√≤ng nh·∫≠p gi√° v√† s·ªë l∆∞·ª£ng h·ª£p l·ªá.');
                return;
            }
            const vnd = price * amount;
            resultEl.textContent = formatVND(vnd);
            const conversions = loadData(historyKey);
            conversions.push({
                type: type,
                price: price,
                amount: amount,
                vnd: vnd,
                timestamp: new Date().toISOString()
            });
            saveData(historyKey, conversions);
            // Save current prices to settings so dashboard can read
            const settings = {
                sellPrice: sellPrice,
                buyPrice: buyPrice,
                updatedAt: new Date().toISOString()
            };
            saveData(settingsKey, settings);
            renderHistory();
        });

        // Clear history button
        clearBtn.addEventListener('click', () => {
            if (confirm('B·∫°n c√≥ mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ chuy·ªÉn ƒë·ªïi?')) {
                saveData(historyKey, []);
                renderHistory();
            }
        });

        // Initialize page: fetch cross rate then render history
        fetchRates();
        renderHistory();
        
        // Add filter and sort event listeners
        document.getElementById('rate-history-filter')?.addEventListener('change', (e) => {
            currentFilter = e.target.value;
            renderHistory();
        });
        
        document.getElementById('rate-history-sort')?.addEventListener('change', (e) => {
            currentSort = e.target.value;
            renderHistory();
        });
        
        // Auto-refresh rate every 1 hour (3600000 ms)
        setInterval(fetchRates, 3600000);
        
        // Add export buttons
        createExportButtons('rate-export-container', 'rate-history', 'TyGia_' + new Date().toISOString().split('T')[0], 'T·ª∑ Gi√°');
    })();
    </script>
    <script src="assets/js/system-embed.js"></script>
</body>
</html>