<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdn.sheetjs.com; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' data:; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.exchangerate-api.com https://open.er-api.com https://api.binance.com https://p2p.binance.com https://*.netlify.app https://*.onrender.com;">
    <title>Qu·∫£n L√Ω Thu Chi</title>
    
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/sheet.css" />
    <link rel="stylesheet" href="assets/css/expense-enhancements.css" />
    
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="navbar">
        <a href="index.html">üè† Trang Ch·ªß</a>
        <a href="dashboard.html">üìä B·∫£ng Ch√≠nh</a>
        <a href="AE.html">üíº B·∫£ng AE</a>
        <a href="AE-QT.html">üåê B·∫£ng AE-QT</a>
        <a href="balance.html">üë• Danh S√°ch T√™n</a>
        <a href="usdt-purchase.html">üí∞ Nh·∫≠p USDT</a>
        <a href="rate.html">üí± T·ª∑ Gi√° USD</a>
        <a href="expense.html" class="active">üí∏ Thu Chi</a>
        <a href="settings.html">‚öôÔ∏è C√†i ƒê·∫∑t</a>
    </nav>
    
    <div class="container">
        <!-- Controls -->
        <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 16px;">
                <select id="month-selector" style="padding: 10px 14px; border-radius: 6px; border: 1px solid #d1d5db; background: white; font-size: 14px; font-weight: 500; cursor: pointer; min-width: 160px; color: #374151;">
                    <!-- Will be populated by JS -->
                </select>
                <input type="text" id="search-input" placeholder="T√¨m ki·∫øm..." style="flex: 1; min-width: 200px; padding: 10px 14px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 14px; color: #374151;">
                <input type="date" id="filter-date-from" style="padding: 10px 14px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 14px; color: #374151;">
                <input type="date" id="filter-date-to" style="padding: 10px 14px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 14px; color: #374151;">
                <button id="clear-filter-btn" style="padding: 10px 16px; border-radius: 6px; border: 1px solid #d1d5db; background: white; color: #6b7280; font-size: 14px; font-weight: 500; cursor: pointer;">
                    X√≥a L·ªçc
                </button>
                <button id="export-btn" style="padding: 10px 16px; border-radius: 6px; border: 1px solid #3b82f6; background: #3b82f6; color: white; font-size: 14px; font-weight: 500; cursor: pointer;">
                    Xu·∫•t Excel
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: white; border-radius: 8px; padding: 20px; border: 2px solid #10b981; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 600;">T·ªïng Thu</div>
                <div style="font-size: 28px; font-weight: 700; color: #10b981; margin-bottom: 4px;" id="total-income">0 ‚Ç´</div>
                <div style="font-size: 13px; color: #9ca3af; font-weight: 500;" id="income-count">0 kho·∫£n</div>
            </div>
            
            <div style="background: white; border-radius: 8px; padding: 20px; border: 2px solid #ef4444; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 600;">T·ªïng Chi</div>
                <div style="font-size: 28px; font-weight: 700; color: #ef4444; margin-bottom: 4px;" id="total-expense">0 ‚Ç´</div>
                <div style="font-size: 13px; color: #9ca3af; font-weight: 500;" id="expense-count">0 kho·∫£n</div>
            </div>
            
            <div style="background: white; border-radius: 8px; padding: 20px; border: 2px solid #3b82f6; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 600;">Ch√™nh L·ªách</div>
                <div style="font-size: 28px; font-weight: 700; color: #3b82f6; margin-bottom: 4px;" id="balance">0 ‚Ç´</div>
                <div style="font-size: 13px; color: #9ca3af; font-weight: 500;" id="balance-status">C√¢n b·∫±ng</div>
            </div>
            
            <div style="background: white; border-radius: 8px; padding: 20px; border: 2px solid #6b7280; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 600;">T·ª∑ L·ªá Chi</div>
                <div style="font-size: 28px; font-weight: 700; color: #6b7280; margin-bottom: 4px;" id="expense-ratio">0%</div>
                <div style="font-size: 13px; color: #9ca3af; font-weight: 500;" id="ratio-status">Ti·∫øt ki·ªám t·ªët</div>
            </div>
        </div>

        <!-- Expense Categories Summary -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; border: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0; color: #374151; font-size: 16px; font-weight: 600;">Chi Ti·∫øt Theo Danh M·ª•c</h3>
                <button id="toggle-category-view" style="padding: 6px 12px; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; color: #6b7280;">
                    Xem Bi·ªÉu ƒê·ªì
                </button>
            </div>
            <div id="category-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                <!-- Will be populated by JS -->
            </div>
        </div>

        <!-- Income & Expense Tables Side by Side -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <!-- Expense Table (Left) -->
            <div>
                <div style="background: white; border-radius: 8px; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; overflow: hidden;">
                    <div style="background: #fef2f2; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #fecaca;">
                        <div>
                            <h3 style="margin: 0; color: #991b1b; font-size: 16px; font-weight: 600;">B·∫£ng Chi Ti√™u</h3>
                            <p style="margin: 4px 0 0 0; color: #dc2626; font-size: 13px; font-weight: 600;">T·ªïng: <span id="expense-total-display" style="font-weight: 700;">0 ‚Ç´</span></p>
                        </div>
                        <button id="add-expense-btn" class="btn-primary" style="padding: 8px 14px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            + Th√™m D√≤ng
                        </button>
                    </div>
                    <div class="table-container" style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                        <table class="sheet" id="expense-table" style="margin: 0; width: 100%; table-layout: fixed;">
                            <thead style="position: sticky; top: 0; z-index: 10;">
                                <tr style="background: #f9fafb; color: #374151; font-weight: 600; font-size: 12px;">
                                    <th style="width: 40px; border: none; padding: 8px 4px; text-align: center;">STT</th>
                                    <th style="width: 110px; border: none; padding: 8px 4px;">Ng√†y</th>
                                    <th style="width: 150px; border: none; padding: 8px 4px;">Danh M·ª•c</th>
                                    <th style="width: 75px; border: none; padding: 8px 4px; text-align: center;">Ti·ªÅn</th>
                                    <th style="width: 130px; border: none; padding: 8px 4px; text-align: right;">S·ªë Ti·ªÅn</th>
                                    <th style="width: 130px; border: none; padding: 8px 4px; text-align: right;">VND</th>
                                    <th style="width: 60px; border: none; padding: 8px 4px; text-align: center;">X√≥a</th>
                                </tr>
                            </thead>
                            <tbody id="expense-tbody">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Income Table (Right) -->
            <div>
                <div style="background: white; border-radius: 8px; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; overflow: hidden;">
                    <div style="background: #f0fdf4; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #bbf7d0;">
                        <div>
                            <h3 style="margin: 0; color: #065f46; font-size: 16px; font-weight: 600;">B·∫£ng Thu Nh·∫≠p</h3>
                            <p style="margin: 4px 0 0 0; color: #059669; font-size: 13px; font-weight: 600;">T·ªïng: <span id="income-total-display" style="font-weight: 700;">0 ‚Ç´</span></p>
                        </div>
                        <button id="add-income-btn" class="btn-primary" style="padding: 8px 14px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            + Th√™m D√≤ng
                        </button>
                    </div>
                    <div class="table-container" style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                        <table class="sheet" id="income-table" style="margin: 0; width: 100%; table-layout: fixed;">
                            <thead style="position: sticky; top: 0; z-index: 10;">
                                <tr style="background: #f9fafb; color: #374151; font-weight: 600; font-size: 12px;">
                                    <th style="width: 40px; border: none; padding: 8px 4px; text-align: center;">STT</th>
                                    <th style="width: 110px; border: none; padding: 8px 4px;">Ng√†y</th>
                                    <th style="width: 150px; border: none; padding: 8px 4px;">Ngu·ªìn Thu</th>
                                    <th style="width: 75px; border: none; padding: 8px 4px; text-align: center;">Ti·ªÅn</th>
                                    <th style="width: 130px; border: none; padding: 8px 4px; text-align: right;">S·ªë Ti·ªÅn</th>
                                    <th style="width: 130px; border: none; padding: 8px 4px; text-align: right;">VND</th>
                                    <th style="width: 60px; border: none; padding: 8px 4px; text-align: center;">X√≥a</th>
                                </tr>
                            </thead>
                            <tbody id="income-tbody">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Suggestions Datalist -->
    <datalist id="category-suggestions">
        <option value="üè† Thu√™ Nh√†">
        <option value="üí° ƒêi·ªán N∆∞·ªõc">
        <option value="üì° Internet">
        <option value="üõí ƒêi Ch·ª£">
        <option value="üçú ƒÇn U·ªëng">
        <option value="üöó Di Chuy·ªÉn">
        <option value="üèçÔ∏è Xe C·ªô">
        <option value="üè• Y T·∫ø">
        <option value="üíä Thu·ªëc Men">
        <option value="üõ°Ô∏è B·∫£o Hi·ªÉm">
        <option value="üì± Thi·∫øt B·ªã">
        <option value="üìû ƒêi·ªán Tho·∫°i">
        <option value="üëï Qu·∫ßn √Åo">
        <option value="üíÑ L√†m ƒê·∫πp">
        <option value="üéÆ Gi·∫£i Tr√≠">
        <option value="üìö H·ªçc T·∫≠p">
        <option value="‚ù§Ô∏è T·ª´ Thi·ªán">
        <option value="üì¶ Kh√°c">
    </datalist>

    <!-- Income Source Suggestions Datalist -->
    <datalist id="income-suggestions">
        <option value="üíº L∆∞∆°ng">
        <option value="üéÅ Th∆∞·ªüng">
        <option value="üí∞ Kinh Doanh">
        <option value="üìà ƒê·∫ßu T∆∞">
        <option value="üíª Freelance">
        <option value="üõçÔ∏è B√°n H√†ng">
        <option value="üè† Cho Thu√™">
        <option value="üè¶ L√£i Su·∫•t">
        <option value="üíµ Ti·ªÅn L√£i">
        <option value="‚è∞ Th√™m Gi·ªù">
        <option value="üìä D·ª± √Ån">
        <option value="ü§ù Hoa H·ªìng">
        <option value="üí∏ Kh√°c">
    </datalist>

    <!-- Income Modal -->
    <div id="income-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h3 style="margin: 0; color: white; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üí∞</span>
                    <span>Th√™m Kho·∫£n Thu</span>
                </h3>
                <button class="modal-close" onclick="closeIncomeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üìÖ</span>
                        <span>Ng√†y</span>
                        <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="date" id="income-date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üíº</span>
                        <span>Ngu·ªìn Thu</span>
                        <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="text" id="income-source" class="form-control" placeholder="VD: L∆∞∆°ng th√°ng 12, Th∆∞·ªüng T·∫øt, L√£i ƒë·∫ßu t∆∞..." required>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üìù</span>
                        <span>M√¥ T·∫£</span>
                    </label>
                    <textarea id="income-description" class="form-control" rows="3" placeholder="Ghi ch√∫ chi ti·∫øt v·ªÅ kho·∫£n thu n√†y..."></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üíµ</span>
                        <span>S·ªë Ti·ªÅn (‚Ç´)</span>
                        <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="text" id="income-amount" class="form-control" placeholder="Nh·∫≠p s·ªë ti·ªÅn" required style="font-size: 16px; font-weight: 600; color: #059669;">
                    <small style="display: block; margin-top: 6px; color: #6b7280; font-size: 12px;">üí° H·ªá th·ªëng t·ª± ƒë·ªông ƒë·ªãnh d·∫°ng s·ªë ti·ªÅn</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeIncomeModal()">‚úï H·ªßy</button>
                <button class="btn-primary" onclick="saveIncome()" style="background: #10b981;">üíæ L∆∞u Kho·∫£n Thu</button>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expense-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <h3 style="margin: 0; color: white; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üí∏</span>
                    <span>Th√™m Kho·∫£n Chi</span>
                </h3>
                <button class="modal-close" onclick="closeExpenseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üìÖ</span>
                        <span>Ng√†y</span>
                        <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="date" id="expense-date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üìÇ</span>
                        <span>Danh M·ª•c</span>
                        <span style="color: #ef4444;">*</span>
                    </label>
                    <select id="expense-category" class="form-control" required style="font-size: 14px;">
                        <option value="">-- Ch·ªçn danh m·ª•c chi ti√™u --</option>
                        <optgroup label="üè† Nh√† ·ªû & Sinh Ho·∫°t">
                            <option value="Thu√™ Nh√†">üè† Thu√™ Nh√†</option>
                            <option value="ƒêi·ªán N∆∞·ªõc">üí° ƒêi·ªán N∆∞·ªõc</option>
                            <option value="Internet">üì° Internet/TV</option>
                        </optgroup>
                        <optgroup label="üçú ƒÇn U·ªëng">
                            <option value="ƒêi Ch·ª£">üõí ƒêi Ch·ª£/Si√™u Th·ªã</option>
                            <option value="ƒÇn U·ªëng">üçú ƒÇn U·ªëng/Nh√† H√†ng</option>
                        </optgroup>
                        <optgroup label="üöó Di Chuy·ªÉn">
                            <option value="Di Chuy·ªÉn">üöó XƒÉng/Xe/Grab</option>
                            <option value="Xe C·ªô">üèçÔ∏è B·∫£o D∆∞·ª°ng Xe</option>
                        </optgroup>
                        <optgroup label="üíä S·ª©c Kh·ªèe">
                            <option value="Y T·∫ø">üè• Kh√°m B·ªánh</option>
                            <option value="Thu·ªëc Men">üíä Thu·ªëc Men</option>
                            <option value="B·∫£o Hi·ªÉm">üõ°Ô∏è B·∫£o Hi·ªÉm</option>
                        </optgroup>
                        <optgroup label="üì± C√¥ng Ngh·ªá & Thi·∫øt B·ªã">
                            <option value="Thi·∫øt B·ªã">üì± ƒêi·ªán T·ª≠/Thi·∫øt B·ªã</option>
                            <option value="ƒêi·ªán Tho·∫°i">üìû C∆∞·ªõc ƒêi·ªán Tho·∫°i</option>
                        </optgroup>
                        <optgroup label="üëï C√° Nh√¢n">
                            <option value="Qu·∫ßn √Åo">üëï Qu·∫ßn √Åo/Ph·ª• Ki·ªán</option>
                            <option value="L√†m ƒê·∫πp">üíÑ L√†m ƒê·∫πp</option>
                        </optgroup>
                        <optgroup label="üéØ Kh√°c">
                            <option value="Gi·∫£i Tr√≠">üéÆ Gi·∫£i Tr√≠</option>
                            <option value="H·ªçc T·∫≠p">üìö H·ªçc T·∫≠p/S√°ch</option>
                            <option value="T·ª´ Thi·ªán">‚ù§Ô∏è T·ª´ Thi·ªán</option>
                            <option value="Kh√°c">üì¶ Kh√°c</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üìù</span>
                        <span>M√¥ T·∫£</span>
                    </label>
                    <textarea id="expense-description" class="form-control" rows="3" placeholder="Ghi ch√∫ chi ti·∫øt v·ªÅ kho·∫£n chi n√†y..."></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üíµ</span>
                        <span>S·ªë Ti·ªÅn (‚Ç´)</span>
                        <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="text" id="expense-amount" class="form-control" placeholder="Nh·∫≠p s·ªë ti·ªÅn" required style="font-size: 16px; font-weight: 600; color: #dc2626;">
                    <small style="display: block; margin-top: 6px; color: #6b7280; font-size: 12px;">üí° H·ªá th·ªëng t·ª± ƒë·ªông ƒë·ªãnh d·∫°ng s·ªë ti·ªÅn</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeExpenseModal()">‚úï H·ªßy</button>
                <button class="btn-primary" onclick="saveExpense()" style="background: #ef4444;">üíæ L∆∞u Kho·∫£n Chi</button>
            </div>
        </div>
    </div>

    <!-- Load scripts -->
    <script src="assets/js/notification.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/supabase-sync.js"></script>
    <script src="assets/js/expense.js"></script>
</body>
</html>
