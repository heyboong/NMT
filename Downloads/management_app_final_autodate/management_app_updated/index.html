<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net https://cdn.sheetjs.com https://*.supabase.co wss://*.supabase.co; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdn.sheetjs.com; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' data:; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.exchangerate-api.com https://open.er-api.com https://api.binance.com https://p2p.binance.com https://*.netlify.app https://*.onrender.com;">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω</title>
    
    <!-- Preconnect to CDN for faster loading -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/index-enhancements.css" />
    
    <!-- API Configuration -->
    <script src="config.js"></script>
    
    <!-- External libraries with defer for non-blocking load -->
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="index.html" class="active">üè† Trang Ch·ªß</a>
        <a href="dashboard.html">üìä B·∫£ng Ch√≠nh</a>
        <a href="AE.html">üíº B·∫£ng AE</a>
        <a href="AE-QT.html">üåê B·∫£ng AE-QT</a>
        <a href="balance.html">üë• Danh S√°ch T√™n</a>
        <a href="usdt-purchase.html">üí∞ Nh·∫≠p USDT</a>
        <a href="rate.html">üí± T·ª∑ Gi√° USD</a>
        <a href="expense.html">üí∏ Thu Chi</a>
        <a href="settings.html">‚öôÔ∏è C√†i ƒê·∫∑t</a>
    </nav>

    <div class="container">
        <!-- Th·ªëng k√™ t·ªïng quan -->
        <div style="margin-bottom: 48px;">
            <div class="cards-grid summary-grid">
                    <div class="card metric-card metric-card--purple" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="card-ornament"></div>
                        <div class="card-body">
                            <h3 class="card-title"><span class="card-icon">üìÖ</span> NG√ÄY ƒê·ªîI $</h3>
                            <div class="stat-list">
                                <div class="stat-row">
                                    <span class="stat-label">USDT</span>
                                    <span class="stat-value" id="home-conversion-usdt">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">USD</span>
                                    <span class="stat-value" id="home-conversion-usd">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Gi√° TB th√°ng n√†y</span>
                                    <span class="stat-value" id="home-conversion-price">0‚Ç´</span>
                                </div>
                            </div>
                            <div class="stat-total">
                                <span class="stat-total__label">T·ªïng ƒë·ªïi VND</span>
                                <span class="stat-total__value" id="home-conversion-total">0‚Ç´</span>
                            </div>
                        </div>
                    </div>
                    <div class="card metric-card metric-card--pink" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="card-ornament"></div>
                        <div class="card-body">
                            <h3 class="card-title"><span class="card-icon">üì§</span> NG√ÄY L·∫§Y VND</h3>
                            <div class="stat-list">
                                <div class="stat-row boxed">
                                    <span class="stat-label">Bank ƒê·∫πp</span>
                                    <span class="stat-value" id="home-withdraw-bankdep">0‚Ç´</span>
                                </div>
                                <div class="stat-row boxed">
                                    <span class="stat-label">Bank X·∫•u</span>
                                    <span class="stat-value" id="home-withdraw-bankbad">0‚Ç´</span>
                                </div>
                                <div class="stat-row boxed">
                                    <span class="stat-label">Visa TT</span>
                                    <span class="stat-value" id="home-withdraw-visa">0‚Ç´</span>
                                </div>
                            </div>
                            <div class="stat-total">
                                <span class="stat-total__label">T·ªîNG L·∫§Y VND</span>
                                <span class="stat-total__value" id="home-withdraw-total">0‚Ç´</span>
                            </div>
                        </div>
                    </div>
                <div class="card metric-card metric-card--white ae-card">
                    <h3 class="card-title ae-title"><span class="card-icon">üíºüåê</span> T·ªïng AE & AE-QT</h3>
                    <div class="ae-rows">
                        <div class="ae-row">
                            <span class="ae-label">AE</span>
                            <span class="ae-value" id="home-ae-total">0‚Ç´</span>
                            <span class="ae-muted">Kh√≥a</span>
                            <span class="ae-value" id="home-ae-locked">0‚Ç´</span>
                        </div>
                        <div class="ae-row">
                            <span class="ae-label">AE-QT</span>
                            <span class="ae-value" id="home-aeqt-total">0‚Ç´</span>
                            <span class="ae-muted">Kh√≥a</span>
                            <span class="ae-value" id="home-aeqt-locked">0‚Ç´</span>
                        </div>
                        <div class="ae-row ae-row--total">
                            <span class="ae-label">T·ªïng c·ªông</span>
                            <span class="ae-value" id="home-ae-sum-total">0‚Ç´</span>
                            <span class="ae-muted">Kh√≥a</span>
                            <span class="ae-value" id="home-ae-sum-locked">0‚Ç´</span>
                        </div>
                    </div>
                </div>
                <div class="card metric-card metric-card--p2p">
                    <div class="card-ornament"></div>
                    <div class="card-body">
                        <h3 class="card-title"><span class="card-icon">üí±</span> T·ªïng th√°ng tr∆∞·ªõc</h3>
                        <div class="p2p-grid">
                            <div class="p2p-block p2p-block--month-total">
                                <div class="p2p-label" id="current-month-label">T·ªîNG TH√ÅNG 12</div>
                                <div class="p2p-value" id="home-total-current">‚Äî</div>
                            </div>
                            <div class="p2p-block">
                                <div class="p2p-label">T·ªïng th√°ng tr∆∞·ªõc</div>
                                <div class="p2p-value" id="home-total-prev">‚Äî</div>
                                <input id="home-total-prev-input" type="number" step="0.01" placeholder="Nh·∫≠p gi√° tr·ªã" class="p2p-input">
                            </div>
                            <div class="p2p-block p2p-block--strong p2p-block--red-border">
                                <div class="p2p-label">T·ªîNG HI·ªÜN T·∫†I</div>
                                <div class="p2p-value" id="home-total-combined">‚Äî</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì v√† th·ªëng k√™ theo th√°ng -->
        <div style="margin-bottom: 48px;">
            <h2 style="font-size: 28px; font-weight: 700; color: #1e293b; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 4px; height: 32px; border-radius: 2px;"></span>
                <span>üìä Th·ªëng K√™ Th√°ng</span>
                <span id="monthly-total-current" style="margin-left: auto; background: linear-gradient(135deg, #0ea5e9, #6366f1); color: #f8fafc; padding: 8px 12px; border-radius: 12px; font-size: 14px; font-weight: 800; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3), 0 0 20px rgba(239, 68, 68, 0.4), 0 6px 16px rgba(99,102,241,0.25); border: 3px solid #ef4444; white-space: nowrap;">
                    üíé <span id="monthly-badge-label">T·ªîNG TH√ÅNG 12</span>: ‚Äî
                </span>
                <span id="hero-p2p-rate" style="margin-left: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 8px 12px; border-radius: 12px; font-size: 14px; font-weight: 800; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3), 0 0 20px rgba(16, 185, 129, 0.4), 0 6px 16px rgba(5, 150, 105, 0.25); border: 3px solid #10b981; white-space: nowrap;">
                    üí± Gi√° P2P USDT Binance: ‚Äî
                </span>
                <span id="hero-p2p-source" style="margin-left: 8px; background: rgba(71, 85, 105, 0.1); color: #475569; padding: 6px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; white-space: nowrap;">
                    ƒêang t·∫£i...
                </span>
            </h2>
            
            <!-- B·∫£ng th·ªëng k√™ th√°ng -->
            <div style="margin-bottom: 32px; overflow-x: auto; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); background: white;">
                <table id="monthly-stats-table" style="width: 100%; border-collapse: separate; border-spacing: 0; background: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <th style="padding: 12px 10px; text-align: center; border: none; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; border-top-left-radius: 16px; position: relative;">
                                <div class="stat-head">
                                    <span style="font-size: 13px;">üìÖ</span>
                                    <span>Th√°ng</span>
                                </div>
                            </th>
                            <th class="stat-usdt-col" style="padding: 12px 8px; text-align: center; border: none; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; position: relative;">
                                <div class="stat-head">
                                    <span style="font-size: 12px;">üíµ</span>
                                    <span>USDT</span>
                                </div>
                            </th>
                            <th class="stat-usd-col" style="padding: 12px 8px; text-align: center; border: none; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; position: relative;">
                                <div class="stat-head">
                                    <span style="font-size: 12px;">üí≤</span>
                                    <span>USD</span>
                                </div>
                            </th>
                            <th style="padding: 12px 8px; text-align: center; border: none; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; position: relative;">
                                <div class="stat-head">
                                    <span style="font-size: 12px;">üìä</span>
                                    <span>Gi√° TB</span>
                                </div>
                            </th>
                            <th style="padding: 12px 8px; text-align: center; border: none; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; position: relative;">
                                <div class="stat-head">
                                    <span style="font-size: 12px;">üí±</span>
                                    <span>ƒê·ªïi</span>
                                </div>
                            </th>
                            <th style="padding: 12px 8px; text-align: center; border: none; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; position: relative;">
                                <div class="stat-head">
                                    <span style="font-size: 12px;">üí∞</span>
                                    <span>L·∫•y</span>
                                </div>
                            </th>
                            <th style="padding: 12px 8px; text-align: center; border: none; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; background: rgba(5, 150, 105, 0.95); position: relative;">
                                <div class="stat-head">
                                    <span style="font-size: 12px;">üíº</span>
                                    <span>AE</span>
                                </div>
                            </th>
                            <th style="padding: 12px 8px; text-align: center; border: none; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; background: rgba(8, 145, 178, 0.95); position: relative;">
                                <div class="stat-head">
                                    <span style="font-size: 16px;">üåê</span>
                                    <span>AE-QT</span>
                                </div>
                            </th>
                            <th style="padding: 12px 8px; text-align: center; border: none; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; background: rgba(220, 38, 38, 0.95); border-top-right-radius: 16px; position: relative;">
                                <div class="stat-head">
                                    <span style="font-size: 12px;">üí∏</span>
                                    <span>Ti·ªÅn L√†m</span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="monthly-stats-body">
                        <!-- Data will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- B·∫£ng t·ªïng ti·ªÅn l√†m h√†ng ng√†y -->
        <div style="margin-bottom: 48px;">
            <h2 style="font-size: 28px; font-weight: 700; color: #1e293b; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                <span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); width: 4px; height: 32px; border-radius: 2px;"></span>
                <span>üìÖ Ti·ªÅn L√†m H√†ng Ng√†y</span>
            </h2>
            
            <div style="margin-bottom: 32px; overflow-x: auto; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); background: white;">
                <table id="daily-earnings-table" style="width: 100%; border-collapse: separate; border-spacing: 0; background: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <th style="padding: 14px 16px; text-align: center; border: none; color: white; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; border-top-left-radius: 16px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 16px;">üìÖ</span>
                                    <span>Ng√†y</span>
                                </div>
                            </th>
                            <th style="padding: 14px 16px; text-align: center; border: none; color: white; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; background: rgba(5, 150, 105, 0.95);">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 16px;">üíº</span>
                                    <span>AE</span>
                                </div>
                            </th>
                            <th style="padding: 14px 16px; text-align: center; border: none; color: white; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; background: rgba(8, 145, 178, 0.95);">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 16px;">üåê</span>
                                    <span>AE-QT</span>
                                </div>
                            </th>
                            <th style="padding: 14px 16px; text-align: center; border: none; color: white; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; background: rgba(239, 68, 68, 0.95); border-top-right-radius: 16px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 16px;">üí∞</span>
                                    <span>T·ªïng C·ªông</span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="daily-earnings-body">
                        <!-- Data will be populated by JS -->
                    </tbody>
                    <tfoot>
                        <tr style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); font-weight: 800; border-top: 3px solid #10b981;">
                            <td style="padding: 16px; text-align: center; color: white; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom-left-radius: 16px;">
                                üìä T·ªïng T·∫•t C·∫£
                            </td>
                            <td id="daily-total-ae" style="padding: 16px; text-align: center; color: #10b981; font-size: 16px; font-weight: 800;">0‚Ç´</td>
                            <td id="daily-total-aeqt" style="padding: 16px; text-align: center; color: #0891b2; font-size: 16px; font-weight: 800;">0‚Ç´</td>
                            <td id="daily-total-combined" style="padding: 16px; text-align: center; color: #fbbf24; font-size: 18px; font-weight: 800; border-bottom-right-radius: 16px;">0‚Ç´</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/notification.js"></script>
    <script src="assets/js/formulas.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/button-effects.js"></script>
    <script src="assets/js/supabase-sync.js"></script>
    <script src="assets/js/monthly-stats.js"></script>
    <script src="assets/js/month-label-updater.js"></script>
    <script>
        // Wait for all scripts to load before defining functions
        (function() {
            'use strict';
            
            // Ensure app.js functions are available
            if (typeof loadData === 'undefined' || typeof formatVND === 'undefined') {
                console.error('‚ùå Required functions not loaded. Retrying...');
                setTimeout(() => location.reload(), 1000);
                return;
            }
            
            console.log('‚úÖ All required functions loaded');
            const formatNumber = (value, decimals = 2) => {
                const num = Number(value || 0);
                return num.toLocaleString('en-US', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                });
            };

            const parseNumberInput = (value) => {
                const sanitized = String(value ?? '0').replace(/[^0-9.-]/g, '');
                const parsed = parseFloat(sanitized);
                return isNaN(parsed) ? 0 : parsed;
            };
            
        // Fetch Binance P2P Rate (via Netlify Function to bypass CORS)
        window.fetchBinanceP2PRate = async function() {
            console.log('üöÄ Fetching P2P rate...');
            
            // Method 1: Netlify Function (Primary - bypasses CORS)
            const origin = window.location.origin;
            const netlifyUrls = [
                `${origin}/.netlify/functions/p2p-rate`,
                window.NETLIFY_FUNCTION_URL
            ].filter(Boolean);
            
            for (let url of netlifyUrls) {
                try {
                    console.log(`üîÑ Trying Netlify Function: ${url}`);
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const sellPrice = parseFloat(data.sellPrice) || 0;
                        
                        if (sellPrice > 0) {
                            console.log('‚úÖ Netlify Function success:', sellPrice, 'VND');
                            return {
                                sellPrice: sellPrice,
                                buyPrice: parseFloat(data.buyPrice) || sellPrice,
                                source: data.source || 'netlify-function',
                                lastFetchedAt: data.timestamp || new Date().toISOString()
                            };
                        }
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Netlify Function ${url} failed:`, error.message);
                }
            }
            
            // Method 2: Try proxy endpoints if configured
            const proxyUrls = [
                window.RATE_PROXY_URL,
                `${origin}/api/p2p-rate`
            ].filter(Boolean);
            
            for (let proxyUrl of proxyUrls) {
                try {
                    console.log(`üîÑ Trying proxy: ${proxyUrl}`);
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const sellPrice = parseFloat(data.sellPrice) || 0;
                        
                        if (sellPrice > 0) {
                            console.log('‚úÖ Proxy API success:', sellPrice, 'VND');
                            return {
                                sellPrice: sellPrice,
                                buyPrice: parseFloat(data.buyPrice) || sellPrice,
                                source: data.source || 'proxy',
                                lastFetchedAt: data.lastFetchedAt || new Date().toISOString()
                            };
                        }
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Proxy ${proxyUrl} failed:`, error.message);
                }
            }
            
            // Method 3: Fallback to Binance Spot Price (ticker)
            try {
                console.log('üîÑ Trying Binance Spot Ticker...');
                const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=USDTVND');
                if (response.ok) {
                    const data = await response.json();
                    const price = parseFloat(data.price) || 0;
                    if (price > 0) {
                        console.log('‚úÖ Binance Ticker success:', price, 'VND');
                        return {
                            sellPrice: price,
                            buyPrice: price,
                            source: 'binance-ticker',
                            lastFetchedAt: new Date().toISOString()
                        };
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Binance Ticker failed:', error.message);
            }
            
            // All APIs failed, use localStorage fallback
            console.warn('‚ö†Ô∏è All API endpoints failed, using localStorage fallback');
            const rateSettings = loadData('rate-settings') || {};
            const fallbackPrice = parseFloat(rateSettings.buyPrice) || 27500;
            console.log('üìå Using fallback price:', fallbackPrice);
            return {
                sellPrice: fallbackPrice,
                buyPrice: fallbackPrice,
                source: 'localStorage',
                lastFetchedAt: rateSettings.updatedAt || null
            };
        }

        // Load summary data
        window.loadHomeSummary = async function() {
            console.log('üîÑ Loading home summary...');
            
            try {
                // Always fetch fresh P2P rate from API first
                let latestP2PPrice = 0;
                let p2pSource = 'localStorage';
                let lastUpdate = null;
                
                console.log('üîÑ Fetching latest P2P rate from API...');
                try {
                    const p2pData = await window.fetchBinanceP2PRate();
                    if (p2pData && p2pData.buyPrice > 0) {
                        latestP2PPrice = p2pData.buyPrice;
                        p2pSource = p2pData.source;
                        lastUpdate = new Date().toISOString();
                        console.log('üí± P2P rate fetched from API:', latestP2PPrice, '(source:', p2pSource + ')');
                        
                        // Update localStorage with latest rate
                        const rateSettings = {
                            buyPrice: latestP2PPrice,
                            sellPrice: p2pData.sellPrice || latestP2PPrice,
                            updatedAt: lastUpdate,
                            source: p2pSource
                        };
                        saveData('rate-settings', rateSettings);
                        saveData('rate_settings', rateSettings); // legacy key
                        console.log('‚úÖ Rate saved to localStorage:', latestP2PPrice);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to fetch P2P rate from API:', error.message);
                }
                
                // Fallback to localStorage if API fetch failed
                if (!latestP2PPrice || latestP2PPrice === 0) {
                    console.log('üì¶ Using rate from localStorage fallback...');
                    const rateSettings = loadData('rate-settings') || loadData('rate_settings') || {};
                    latestP2PPrice = parseFloat(rateSettings.buyPrice) || parseFloat(rateSettings.sellPrice) || 0;
                    p2pSource = rateSettings.source || 'localStorage';
                    lastUpdate = rateSettings.updatedAt || rateSettings.lastFetchedAt;
                    console.log('üí± P2P rate from localStorage:', latestP2PPrice, '(source:', p2pSource + ')');
                }
                
                // Final hard fallback if still no rate
                if (!latestP2PPrice || latestP2PPrice === 0) {
                    console.warn('‚ö†Ô∏è No valid rate available, using hard fallback');
                    latestP2PPrice = 27500; // Hard fallback
                    p2pSource = 'fallback';
                }
                
                console.log('üìÖ Last updated:', lastUpdate);
                
                // Conversion data (NG√ÄY ƒê·ªîI)
                const conversionData = loadData('dashboard_conversion') || [];
                console.log('üìÖ Conversion data:', conversionData.length, 'records');
                
                // T√≠nh gi√° trung b√¨nh th√°ng hi·ªán t·∫°i v√† th√°ng tr∆∞·ªõc t·ª´ c·ªôt D (Gi√° VND)
                const now = new Date();
                const currentMonth = now.getMonth() + 1;
                const currentYear = now.getFullYear();
                const prevRef = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const prevMonth = prevRef.getMonth() + 1;
                const prevYear = prevRef.getFullYear();
                
                let monthlyPriceSum = 0;
                let monthlyPriceCount = 0;
                let totalUSDT = 0, totalUSD = 0, totalVND = 0;
                let prevMonthlyPriceSum = 0;
                let prevMonthlyPriceCount = 0;
                let prevTotalVND = 0;
                let currentMonthVND = 0;
                
                conversionData.forEach(item => {
                    totalUSDT += parseFloat(item.usdt) || 0;
                    totalUSD += parseFloat(item.usd) || 0;
                    totalVND += parseFloat(item.vnd) || 0;
                    
                    // Ki·ªÉm tra xem date c√≥ thu·ªôc th√°ng hi·ªán t·∫°i ho·∫∑c th√°ng tr∆∞·ªõc
                    const price = parseFloat(item.price) || 0;
                    if (price > 0 && item.date) {
                        const dateParts = item.date.split('/');
                        if (dateParts.length === 3) {
                            const itemMonth = parseInt(dateParts[1], 10);
                            const itemYear = parseInt(dateParts[2], 10);
                            
                            if (itemMonth === currentMonth && itemYear === currentYear) {
                                monthlyPriceSum += price;
                                monthlyPriceCount++;
                                currentMonthVND += parseFloat(item.vnd) || 0;
                            } else if (itemMonth === prevMonth && itemYear === prevYear) {
                                prevMonthlyPriceSum += price;
                                prevMonthlyPriceCount++;
                            }
                        }
                    }

                    // T·ªïng VND th√°ng tr∆∞·ªõc (v√† th√°ng n√†y)
                    if (item.date) {
                        const dateParts = item.date.split('/');
                        if (dateParts.length === 3) {
                            const itemMonth = parseInt(dateParts[1], 10);
                            const itemYear = parseInt(dateParts[2], 10);
                            const vndVal = parseFloat(item.vnd) || 0;
                            if (itemMonth === prevMonth && itemYear === prevYear) {
                                prevTotalVND += vndVal;
                            }
                            if (itemMonth === currentMonth && itemYear === currentYear) {
                                currentMonthVND += vndVal;
                            }
                        }
                    }
                });
                
                const monthlyAvgPrice = monthlyPriceCount > 0 ? monthlyPriceSum / monthlyPriceCount : 0;
                const prevMonthlyAvgPrice = prevMonthlyPriceCount > 0 ? prevMonthlyPriceSum / prevMonthlyPriceCount : 0;
                console.log('üìä Monthly average price:', monthlyAvgPrice, 'from', monthlyPriceCount, 'records');
                console.log('üìä Conversion totals - USDT:', totalUSDT, 'USD:', totalUSD, 'VND:', totalVND);
                
                document.getElementById('home-conversion-usdt').textContent = formatNumber(totalUSDT, 1) + ' $';
                document.getElementById('home-conversion-usd').textContent = formatNumber(totalUSD, 1) + ' $';
                document.getElementById('home-conversion-price').textContent = formatVND(monthlyAvgPrice);
                document.getElementById('home-conversion-total').textContent = formatVND(totalVND);

                // Withdraw data (NG√ÄY L·∫§Y)
                const withdrawData = loadData('dashboard_withdraw') || [];
                console.log('üì§ Withdraw data:', withdrawData.length, 'records');
                let totalWithdraw = 0;
                let currentWithdraw = 0;
                let prevWithdraw = 0;
                let sumBankDep = 0;
                let sumBankBad = 0;
                let sumVisa = 0;
                
                withdrawData.forEach(item => {
                    const bankdep = parseFloat(item.bankdep) || 0;
                    const bankbad = parseFloat(item.bankbad) || 0;
                    const visa = parseFloat(item.visa) || 0;
                    if (bankdep > 0) sumBankDep += bankdep;
                    if (bankbad > 0) sumBankBad += bankbad;
                    if (visa > 0) sumVisa += visa;
                    const sumRow = bankdep + bankbad + visa;
                    totalWithdraw += sumRow;

                    if (item.date) {
                        const parts = item.date.split('/');
                        if (parts.length === 3) {
                            const m = parseInt(parts[1], 10);
                            const y = parseInt(parts[2], 10);
                            if (m === currentMonth && y === currentYear) {
                                currentWithdraw += sumRow;
                            } else if (m === prevMonth && y === prevYear) {
                                prevWithdraw += sumRow;
                            }
                        }
                    }
                });
                
                console.log('üìä Withdraw total:', totalWithdraw);
                
                // Hi·ªÉn th·ªã Bank ƒë·∫πp, Bank x·∫•u, Visa TT v√† t·ªïng l·∫•y VND
                const bankDepEl = document.getElementById('home-withdraw-bankdep');
                const bankBadEl = document.getElementById('home-withdraw-bankbad');
                const visaEl = document.getElementById('home-withdraw-visa');
                const totalWithdrawEl = document.getElementById('home-withdraw-total');
                if (bankDepEl) bankDepEl.textContent = formatVND(sumBankDep);
                if (bankBadEl) bankBadEl.textContent = formatVND(sumBankBad);
                if (visaEl) visaEl.textContent = formatVND(sumVisa);
                if (totalWithdrawEl) totalWithdrawEl.textContent = formatVND(totalWithdraw);

                // AE data
                const aeData = loadData('AE_sheet') || [];
                console.log('üíº AE data:', aeData.length, 'records');
                let aeTotal = 0, aeLocked = 0;
                
                aeData.forEach(item => {
                    const money = parseFloat(item.money) || 0;
                    aeTotal += money;
                    
                    // Ki·ªÉm tra n·∫øu kh√≥a = 1
                    if (parseInt(item.khoa) === 1) {
                        aeLocked += money;
                    }
                });
                
                console.log('üìä AE totals - Total:', aeTotal, 'Locked:', aeLocked);
                
                document.getElementById('home-ae-total').textContent = formatVND(aeTotal);
                document.getElementById('home-ae-locked').textContent = formatVND(aeLocked);

                // AE-QT data
                const aeqtData = loadData('AEQT_sheet') || [];
                console.log('üåê AE-QT data:', aeqtData.length, 'records');
                let aeqtTotal = 0, aeqtLocked = 0;
                
                aeqtData.forEach(item => {
                    const money = parseFloat(item.money) || 0;
                    aeqtTotal += money;
                    
                    // Ki·ªÉm tra n·∫øu kh√≥a = 1
                    if (parseInt(item.khoa) === 1) {
                        aeqtLocked += money;
                    }
                });
                
                console.log('üìä AE-QT totals - Total:', aeqtTotal, 'Locked:', aeqtLocked);
                
                document.getElementById('home-aeqt-total').textContent = formatVND(aeqtTotal);
                document.getElementById('home-aeqt-locked').textContent = formatVND(aeqtLocked);

                // T·ªïng c·ªông AE + AE-QT
                const totalCombined = aeTotal + aeqtTotal;
                const lockedCombined = aeLocked + aeqtLocked;
                document.getElementById('home-ae-sum-total').textContent = formatVND(totalCombined);
                document.getElementById('home-ae-sum-locked').textContent = formatVND(lockedCombined);

                // B·ªè ch·ªânh th√°ng tr∆∞·ªõc/T·ªïng c·ªông ·ªü th·∫ª AE

                // P2P Rate - hi·ªÉn th·ªã gi√° t·ª´ API ho·∫∑c localStorage
                const rateElement = document.getElementById('home-rate-avg');
                if (rateElement) rateElement.textContent = '';
                const heroRateEl = document.getElementById('hero-p2p-rate');
                if (heroRateEl) heroRateEl.textContent = 'üí± Gi√° P2P USDT Binance: ' + formatVND(latestP2PPrice);
                const sourceLabel = document.getElementById('p2p-source-label');
                const heroSourceEl = document.getElementById('hero-p2p-source');
                let statusText = 'üü° Ch∆∞a c·∫≠p nh·∫≠t';
                if (latestP2PPrice > 0) {
                    const updateTime = lastUpdate ? new Date(lastUpdate).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '';
                    if (p2pSource === 'binance-p2p' || p2pSource === 'binance') {
                        statusText = updateTime ? `üü¢ Binance P2P (${updateTime})` : 'üü¢ Binance P2P (Live)';
                    } else if (p2pSource === 'binance-direct') {
                        statusText = updateTime ? `üü¢ Binance Direct (${updateTime})` : 'üü¢ Binance Direct';
                    } else if (p2pSource === 'proxy' || p2pSource === 'api') {
                        statusText = updateTime ? `üü¢ API Live (${updateTime})` : 'üü¢ API Live';
                    } else if (p2pSource === 'localStorage') {
                        statusText = updateTime ? `üì¶ LocalStorage (${updateTime})` : 'üì¶ LocalStorage';
                    } else if (p2pSource === 'fallback') {
                        statusText = '‚ö†Ô∏è Gi√° d·ª± ph√≤ng';
                    } else {
                        statusText = updateTime ? `üü¢ ƒê√£ c·∫≠p nh·∫≠t (${updateTime})` : 'üü¢ ƒê√£ c·∫≠p nh·∫≠t';
                    }
                }
                if (sourceLabel) sourceLabel.textContent = '';
                if (heroSourceEl) heroSourceEl.textContent = statusText;

                // T·ªîNG C·ªòNG card logic: d√πng c·ªôt T·ªïng t·ª´ b·∫£ng Th·ªëng K√™ Theo Th√°ng
                const totalCurrentEl = document.getElementById('home-total-current');
                const totalPrevEl = document.getElementById('home-total-prev');
                const totalCombinedEl = document.getElementById('home-total-combined');

                let currentMonthTotal = null;
                let prevMonthTotal = null;

                if (typeof window.calculateMonthlyStats === 'function') {
                    const monthlyStats = window.calculateMonthlyStats();
                    const sortedMonths = Object.keys(monthlyStats).sort().reverse();
                    if (sortedMonths.length > 0) {
                        currentMonthTotal = monthlyStats[sortedMonths[0]].totalSum;
                    }
                    if (sortedMonths.length > 1) {
                        prevMonthTotal = monthlyStats[sortedMonths[1]].totalSum;
                    }
                }

                // Manual override for prev month
                const manualPrevRaw = localStorage.getItem('total_prev_manual');
                const manualPrev = manualPrevRaw !== null ? parseFloat(manualPrevRaw) : null;
                const hasManualPrev = manualPrev !== null && isFinite(manualPrev);
                if (hasManualPrev) {
                    prevMonthTotal = manualPrev;
                }

                const combinedValue = (isFinite(currentMonthTotal) ? currentMonthTotal : 0) + (isFinite(prevMonthTotal) ? (prevMonthTotal < 0 ? -prevMonthTotal : prevMonthTotal) : 0);

                if (totalCurrentEl) totalCurrentEl.textContent = isFinite(currentMonthTotal) ? formatVND(currentMonthTotal) : '‚Äî';
                if (totalPrevEl) totalPrevEl.textContent = isFinite(prevMonthTotal) ? formatVND(prevMonthTotal) : '‚Äî';
                if (totalCombinedEl) totalCombinedEl.textContent = isFinite(combinedValue) ? formatVND(combinedValue) : '‚Äî';

                const prevInput = document.getElementById('home-total-prev-input');
                if (prevInput && hasManualPrev) prevInput.value = manualPrev;
                
                console.log('‚úÖ Home summary loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading home summary:', error);
            }
        }
        
        // Check if data exists and show warning if not
        window.checkDataAvailability = function() {
            const conversionData = loadData('dashboard_conversion') || [];
            const withdrawData = loadData('dashboard_withdraw') || [];
            const aeData = loadData('AE_sheet') || [];
            const aeqtData = loadData('AEQT_sheet') || [];
            
            const totalRecords = conversionData.length + withdrawData.length + aeData.length + aeqtData.length;
            
            if (totalRecords === 0) {
                console.warn('‚ö†Ô∏è WARNING: No data found in localStorage!');
                console.log('üí° Please add data in the following pages:');
                console.log('   - üìä B·∫£ng ƒêi·ªÅu Khi·ªÉn: Add NG√ÄY ƒê·ªîI and NG√ÄY L·∫§Y data');
                console.log('   - üíº B·∫£ng AE: Add AE data');
                console.log('   - üåê B·∫£ng AE-QT: Add AE-QT data');
            } else {
                console.log(`‚úÖ Data found: ${totalRecords} total records`);
            }
        }

        // Init manual previous-month total input
        window.initManualPrevTotal = function() {
            const input = document.getElementById('home-total-prev-input');
            if (!input) return;

            const stored = localStorage.getItem('total_prev_manual');
            if (stored !== null) input.value = stored;

            const autoSave = () => {
                const val = parseFloat(input.value);
                if (isFinite(val)) {
                    localStorage.setItem('total_prev_manual', val);
                } else {
                    localStorage.removeItem('total_prev_manual');
                }
                window.loadHomeSummary();
            };

            input.addEventListener('input', autoSave);
            input.addEventListener('blur', autoSave);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    autoSave();
                }
            });
        }

        // Init manual previous-month P2P input
        window.initP2PManualPrev = function() {
            const input = document.getElementById('p2p-prev-input');
            if (!input) return;

            // Prefill input from storage if exists
            const stored = localStorage.getItem('p2p_prev_manual');
            if (stored !== null) {
                input.value = stored;
            }

            const autoSave = () => {
                const val = parseFloat(input.value);
                if (isFinite(val)) {
                    localStorage.setItem('p2p_prev_manual', val);
                } else {
                    localStorage.removeItem('p2p_prev_manual');
                }
                window.loadHomeSummary();
            };

            input.addEventListener('input', autoSave);
            input.addEventListener('blur', autoSave);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    autoSave();
                }
            });
        }
        
        /**
         * Load and display daily earnings from AE and AE-QT tables
         */
        window.loadDailyEarnings = function() {
            console.log('üìÖ Loading daily earnings...');
            
            const tableBody = document.getElementById('daily-earnings-body');
            const totalAEEl = document.getElementById('daily-total-ae');
            const totalAEQTEl = document.getElementById('daily-total-aeqt');
            const totalCombinedEl = document.getElementById('daily-total-combined');
            
            if (!tableBody) {
                console.warn('‚ö†Ô∏è Daily earnings table not found');
                return;
            }
            
            // Load data from localStorage
            const aeData = loadData('AE_sheet') || [];
            const aeqtData = loadData('AEQT_sheet') || [];
            
            // Helper function to normalize dates
            const normalizeDate = (dateStr) => {
                if (!dateStr) return '';
                const cleaned = dateStr.trim();
                if (!cleaned) return '';
                
                // Try DD/MM/YYYY or DD-MM-YYYY format
                const dmyMatch = cleaned.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
                if (dmyMatch) {
                    const day = dmyMatch[1].padStart(2, '0');
                    const month = dmyMatch[2].padStart(2, '0');
                    const year = dmyMatch[3];
                    return `${year}-${month}-${day}`;
                }
                
                // Try YYYY-MM-DD format
                const ymdMatch = cleaned.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
                if (ymdMatch) {
                    const year = ymdMatch[1];
                    const month = ymdMatch[2].padStart(2, '0');
                    const day = ymdMatch[3].padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                return cleaned;
            };
            
            // Group AE data by date
            const aeByDate = {};
            aeData.forEach(row => {
                if (row && row.date) {
                    const normalized = normalizeDate(row.date);
                    if (normalized) {
                        if (!aeByDate[normalized]) {
                            aeByDate[normalized] = 0;
                        }
                        const money = parseFloat(row.money) || 0;
                        aeByDate[normalized] += money;
                    }
                }
            });
            
            // Group AE-QT data by date
            const aeqtByDate = {};
            aeqtData.forEach(row => {
                if (row && row.date) {
                    const normalized = normalizeDate(row.date);
                    if (normalized) {
                        if (!aeqtByDate[normalized]) {
                            aeqtByDate[normalized] = 0;
                        }
                        const money = parseFloat(row.money) || 0;
                        aeqtByDate[normalized] += money;
                    }
                }
            });
            
            // Get all unique dates and sort descending (newest first)
            const allDates = new Set([...Object.keys(aeByDate), ...Object.keys(aeqtByDate)]);
            const sortedDates = Array.from(allDates).sort((a, b) => b.localeCompare(a));
            
            // Calculate totals
            let totalAE = 0;
            let totalAEQT = 0;
            
            // Clear table
            tableBody.innerHTML = '';
            
            // Populate table
            sortedDates.forEach((date, index) => {
                const aeAmount = aeByDate[date] || 0;
                const aeqtAmount = aeqtByDate[date] || 0;
                const combined = aeAmount + aeqtAmount;
                
                totalAE += aeAmount;
                totalAEQT += aeqtAmount;
                
                // Format date back to DD/MM/YYYY
                const parts = date.split('-');
                const displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
                
                const tr = document.createElement('tr');
                tr.style.transition = 'all 0.2s ease';
                
                // Alternate row colors
                if (index % 2 === 0) {
                    tr.style.background = '#f8fafc';
                } else {
                    tr.style.background = 'white';
                }
                
                // Hover effect
                tr.addEventListener('mouseenter', function() {
                    this.style.background = '#e0f2fe';
                    this.style.transform = 'scale(1.01)';
                });
                tr.addEventListener('mouseleave', function() {
                    if (index % 2 === 0) {
                        this.style.background = '#f8fafc';
                    } else {
                        this.style.background = 'white';
                    }
                    this.style.transform = 'scale(1)';
                });
                
                // Date column
                const dateCell = document.createElement('td');
                dateCell.textContent = displayDate;
                dateCell.style.padding = '12px 16px';
                dateCell.style.textAlign = 'center';
                dateCell.style.fontWeight = '600';
                dateCell.style.color = '#1e293b';
                dateCell.style.fontSize = '14px';
                tr.appendChild(dateCell);
                
                // AE column
                const aeCell = document.createElement('td');
                aeCell.textContent = aeAmount > 0 ? formatVND(aeAmount) : '‚Äî';
                aeCell.style.padding = '12px 16px';
                aeCell.style.textAlign = 'center';
                aeCell.style.fontWeight = '600';
                aeCell.style.color = aeAmount > 0 ? '#059669' : '#94a3b8';
                aeCell.style.fontSize = '14px';
                tr.appendChild(aeCell);
                
                // AE-QT column
                const aeqtCell = document.createElement('td');
                aeqtCell.textContent = aeqtAmount > 0 ? formatVND(aeqtAmount) : '‚Äî';
                aeqtCell.style.padding = '12px 16px';
                aeqtCell.style.textAlign = 'center';
                aeqtCell.style.fontWeight = '600';
                aeqtCell.style.color = aeqtAmount > 0 ? '#0891b2' : '#94a3b8';
                aeqtCell.style.fontSize = '14px';
                tr.appendChild(aeqtCell);
                
                // Combined column
                const combinedCell = document.createElement('td');
                combinedCell.textContent = formatVND(combined);
                combinedCell.style.padding = '12px 16px';
                combinedCell.style.textAlign = 'center';
                combinedCell.style.fontWeight = '700';
                combinedCell.style.color = '#dc2626';
                combinedCell.style.fontSize = '15px';
                tr.appendChild(combinedCell);
                
                tableBody.appendChild(tr);
            });
            
            // Update footer totals
            if (totalAEEl) totalAEEl.textContent = formatVND(totalAE);
            if (totalAEQTEl) totalAEQTEl.textContent = formatVND(totalAEQT);
            if (totalCombinedEl) totalCombinedEl.textContent = formatVND(totalAE + totalAEQT);
            
            console.log(`‚úÖ Daily earnings loaded: ${sortedDates.length} days, AE: ${formatVND(totalAE)}, AE-QT: ${formatVND(totalAEQT)}, Total: ${formatVND(totalAE + totalAEQT)}`);
        };
        
        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Page loaded, initializing...');
            
            // Initialize Supabase sync
            if (window.SupabaseSync && window.SupabaseSync.init) {
                await window.SupabaseSync.init();
            }
            
            // Load summary data
            await window.loadHomeSummary();
            
            // Load daily earnings
            window.loadDailyEarnings();
            
            // Check data availability
            window.checkDataAvailability();

            // Hook manual prev total input
            window.initManualPrevTotal();
            
            // Auto refresh P2P rate every 10 minutes
            const refreshInterval = window.P2P_REFRESH_INTERVAL || (10 * 60 * 1000); // 10 ph√∫t
            setInterval(() => {
                window.loadHomeSummary();
                window.loadDailyEarnings(); // Also refresh daily earnings
                console.log('üîÑ T·ª± ƒë·ªông c·∫≠p nh·∫≠t gi√° P2P l√∫c', new Date().toLocaleTimeString('vi-VN'));
            }, refreshInterval);
            
            // Initialize monthly statistics
            setTimeout(() => {
                if (window.initMonthlyStats) {
                    window.initMonthlyStats();
                }
            }, 500);
            
            // Refresh data when storage changes
            window.addEventListener('storage', () => {
                window.loadHomeSummary();
                window.loadDailyEarnings();
            });
        });
        
        })(); // End of IIFE
    </script>
</body>
</html>