<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lá»‹ch Sá»­</title>
    <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
    <nav class="navbar">
        <a href="index.html">ğŸ  Trang Chá»§</a>
        <a href="dashboard.html">ğŸ“Š Báº£ng Äiá»u Khiá»ƒn</a>
        <a href="AE.html">ğŸ’¼ Báº£ng AE</a>
        <a href="AE-QT.html">ğŸŒ Báº£ng AE-QT</a>
        <a href="history.html" class="active">ğŸ“œ Lá»‹ch Sá»­</a>
        <a href="rate.html">ğŸ’± Tá»· GiÃ¡ USD</a>
        <a href="usdt-purchase.html">ğŸ’° GiÃ¡ Nháº­p USDT</a>
        <a href="balance.html">ğŸ‘¥ Danh SÃ¡ch TÃªn</a>
        <a href="settings.html">âš™ï¸ CÃ i Äáº·t</a>
        <a href="system.html">ğŸ”§ Quáº£n LÃ½</a>
    </nav>

    <div class="container">
        <h2>ğŸ“œ Lá»‹ch Sá»­</h2>
        <div class="table-responsive">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>Thá»i gian</th>
                        <th>Trang</th>
                        <th>NgÃ y</th>
                        <th>Tiá»n lÃ m (VND)</th>
                        <th>TÃªn</th>
                        <th>Chia</th>
                        <th>KhÃ³a</th>
                        <th>VNÄ (VND)</th>
                        <th>Ghi chÃº</th>
                        <th>Tá»•ng tiá»n (VND)</th>
                        <th>Thao tÃ¡c</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows inserted by JS -->
                </tbody>
            </table>
        </div>
        <button id="clear-history" class="btn btn-danger btn-spacing">XÃ³a táº¥t cáº£ lá»‹ch sá»­</button>
        <div id="history-export-container"></div>

        <section id="system-embed-root" data-page="history" class="system-embed-section"></section>
    </div>

    <script src="assets/js/formulas.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/button-effects.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="assets/js/export.js"></script>
    <script src="assets/js/supabase-sync.js"></script>
    <script>
    (function() {
        const tbody = document.querySelector('#history-table tbody');
        const clearBtn = document.getElementById('clear-history');

        // Use global formatVND from app.js

        function render() {
            const history = loadData('history');
            tbody.innerHTML = '';
            history.forEach((record, index) => {
                const tr = document.createElement('tr');
                const rowTotal = computeRowTotal(record);
                const cells = [
                    // Format timestamp using Hanoi time zone (UTC+7) for consistency
                    (function() {
                        try {
                            return new Date(record.timestamp).toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
                        } catch (e) {
                            return new Date(record.timestamp).toLocaleString('vi-VN');
                        }
                    })(),
                    record.page || '',
                    record.date || '',
                    // Format money as VND (header indicates VND)
                    (record.money !== undefined && record.money !== null ? formatVND(record.money) : ''),
                    record.name || '',
                    record.chia || '',
                    record.khoa || '',
                    record.vnd ? formatVND(record.vnd) : '',
                    record.note || '',
                    formatVND(rowTotal)
                ];
                cells.forEach(text => {
                    const td = document.createElement('td');
                    td.textContent = text;
                    tr.appendChild(td);
                });
                // actions
                const actionTd = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'XÃ³a';
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.addEventListener('click', () => {
                    deleteRecord(index);
                });
                actionTd.appendChild(deleteBtn);
                tr.appendChild(actionTd);
                tbody.appendChild(tr);
            });
        }

        function deleteRecord(index) {
            const history = loadData('history');
            history.splice(index, 1);
            saveData('history', history);
            render();
        }

        clearBtn.addEventListener('click', () => {
            if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a toÃ n bá»™ lá»‹ch sá»­?')) {
                saveData('history', []);
                render();
            }
        });

        render();
        
        // Add export buttons
        createExportButtons('history-export-container', 'history', 'LichSu_' + new Date().toISOString().split('T')[0], 'Lá»‹ch Sá»­');
    })();
    </script>
    <script src="assets/js/system-embed.js"></script>
</body>
</html>